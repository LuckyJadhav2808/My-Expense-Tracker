<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Expense Tracker</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <i class="fas fa-sun toggle-theme-btn" id="themeToggle"></i> </div>
            <div class="header-center">
                <h1 class="app-title">Expense Tracker</h1>
            </div>
            <div class="header-right">
                <i class="fas fa-calculator toggle-calculator-btn" id="calculatorToggle"></i> </div>
        </header>

        <main class="main-content">
            <section id="dashboard-view" class="view active">
                <div class="balance-card">
                    <p class="balance-label">Current Balance</p>
                    <p class="balance-amount">₹ <span>0.00</span></p>
                </div>

                <h2 class="section-title">Recent Transactions</h2>
                <ul class="transaction-list" id="recent-transaction-list">
                    <li class="no-transactions">No transactions yet! Add one to get started.</li>
                </ul>
            </section>

            <section id="add-expense-view" class="view">
                <h2 class="section-title">Add New Transaction</h2>
                <form id="expense-form" class="expense-form">
                    <input type="hidden" id="expense-id"> <div class="form-group">
                        <label for="transaction-type">Transaction Type</label>
                        <div class="transaction-type-selector">
                            <input type="radio" id="type-expense" name="transaction-type" value="expense" checked>
                            <label for="type-expense">Expense</label>
                            <input type="radio" id="type-income" name="transaction-type" value="income">
                            <label for="type-income">Income</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="expense-amount">Amount</label>
                        <input type="number" id="expense-amount" placeholder="e.g., 500" required step="0.01">
                        </div>
                    <div class="form-group">
                        <label for="expense-description">Description</label>
                        <input type="text" id="expense-description" placeholder="e.g., Dinner with friends" required>
                    </div>
                     <div class="form-group">
                        <label for="expense-date">Date</label>
                        <input type="date" id="expense-date" value="" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-category">Category</label>
                        <select id="expense-category" required>
                            <option value="">Select a category</option>
                        </select>
                    </div>
                    <button type="submit" class="primary-btn" id="save-expense-btn">Add Transaction</button>
                    <button type="button" class="secondary-btn back-to-dashboard-btn">Cancel</button>
                </form>

                </section>

            <section id="categories-view" class="view">
                <h2 class="section-title">Manage Categories</h2>
                <ul id="category-list" class="category-list">
                    </ul>
                <div class="add-category-section">
                    <input type="text" id="new-category-name" placeholder="New category name" class="new-category-input">
                    <button id="add-new-category-btn" class="primary-btn">Add Category</button>
                </div>
                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

             <section id="filtered-transactions-view" class="view">
                <h2 class="section-title">Filtered Transactions</h2>
                <div class="transaction-filters">
                    <input type="date" id="filter-start-date" placeholder="From Date">
                    <input type="date" id="filter-end-date" placeholder="To Date">
                    <select id="filter-category">
                        <option value="all">All Categories</option>
                        </select>
                    <select id="filter-type"> <option value="all">All Types</option>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                    <button class="secondary-btn small-btn" id="apply-filter-btn">Apply Filters</button>
                    <button class="secondary-btn small-btn" id="clear-filter-btn">Clear Filters</button>
                </div>
                <ul class="transaction-list" id="filtered-transaction-list">
                    <li class="no-transactions">Apply filters to see transactions.</li>
                </ul>
                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

            <section id="borrowed-lent-view" class="view">
                <h2 class="section-title">Borrowed/Lent Money</h2>
                <div class="summary-cards">
                    <div class="summary-card owed">
                        <h3>Money Owed to You</h3>
                        <p class="amount">₹ <span id="total-lent">0.00</span></p>
                    </div>
                    <div class="summary-card owing">
                        <h3>Money You Owe</h3>
                        <p class="amount">₹ <span id="total-borrowed">0.00</span></p>
                    </div>
                </div>

                <button class="primary-btn" id="add-borrow-lent-btn">Add Record</button>

                <h3 class="subsection-title">All Records</h3>
                <ul class="borrowed-lent-list" id="borrowed-lent-list">
                    <li class="no-records">No borrowed/lent records yet.</li>
                </ul>
                 <button type="button" class="secondary-btn back-to-borrow-lent-btn">Back to Dashboard</button>
            </section>

            <section id="add-borrow-lent-view" class="view">
                <h2 class="section-title">Add/Edit Money Record</h2>
                <form id="borrow-lent-form" class="expense-form">
                    <input type="hidden" id="borrow-lent-id">
                    <div class="form-group">
                        <label for="borrow-lent-type">Record Type</label>
                        <div class="transaction-type-selector">
                            <input type="radio" id="type-lent" name="borrow-lent-type" value="lent" checked>
                            <label for="type-lent">Money Lent</label>
                            <input type="radio" id="type-borrowed" name="borrow-lent-type" value="borrowed">
                            <label for="type-borrowed">Money Borrowed</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-amount">Amount</label>
                        <input type="number" id="borrow-lent-amount" placeholder="e.g., 200" required step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-person">Person/Party</label>
                        <input type="text" id="borrow-lent-person" placeholder="e.g., John Doe" required>
                    </div>
                     <div class="form-group">
                        <label for="borrow-lent-date">Date</label>
                        <input type="date" id="borrow-lent-date" value="" required>
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-notes">Notes (Optional)</label>
                        <textarea id="borrow-lent-notes" rows="3" placeholder="e.g., For lunch"></textarea>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="borrow-lent-paid">
                        <label for="borrow-lent-paid">Mark as Paid/Returned</label>
                    </div>
                    <button type="submit" class="primary-btn" id="save-borrow-lent-btn">Save Record</button>
                    <button type="button" class="secondary-btn back-to-borrow-lent-btn">Cancel</button>
                </form>
            </section>

            <section id="budget-view" class="view">
                <h2 class="section-title">Monthly Budget</h2>
                <div class="budget-controls">
                    <button id="prev-month-btn" class="icon-btn"><i class="fas fa-chevron-left"></i></button>
                    <span id="current-budget-month" class="month-display">July 2025</span>
                    <button id="next-month-btn" class="icon-btn"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="form-group budget-goal-input-group">
                    <label for="monthly-budget-goal">Set Monthly Budget Goal (₹)</label>
                    <input type="number" id="monthly-budget-goal" placeholder="e.g., 10000" step="0.01">
                    <button id="save-budget-goal-btn" class="primary-btn small-btn">Save</button>
                </div>

                <div class="budget-summary-card">
                    <div class="summary-item">
                        <p class="summary-label">Budget Goal</p>
                        <p class="summary-value budget-goal">₹ <span id="display-budget-goal">0.00</span></p>
                    </div>
                    <div class="summary-item">
                        <p class="summary-label">Total Expenses</p>
                        <p class="summary-value total-expenses">₹ <span id="display-total-expenses">0.00</span></p>
                    </div>
                    <div class="summary-item">
                        <p class="summary-label">Remaining Budget</p>
                        <p class="summary-value remaining-budget">₹ <span id="display-remaining-budget" class="positive">0.00</span></p>
                    </div>
                </div>

                <div class="budget-progress-bar-container">
                    <div class="budget-progress-bar" id="budget-progress-bar"></div>
                </div>
                <p class="progress-label" id="budget-progress-label">0% of budget used</p>

                <h3 class="subsection-title">Expenses by Category for this Month</h3>
                <ul id="budget-category-expenses-list" class="category-summary-list">
                    <li class="no-categories">No expenses for this month.</li>
                </ul>

                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>


        </main>

        <div id="calculator" class="calculator-container" style="display: none;">
            <div class="calculator-display">
                <input type="text" id="calc-output" readonly value="0">
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn clear" data-action="clear">C</button>
                <button class="calc-btn operator" data-action="divide">/</button>
                <button class="calc-btn operator" data-action="multiply">*</button>
                <button class="calc-btn backspace" data-action="backspace"><i class="fas fa-backspace"></i></button>

                <button class="calc-btn number">7</button>
                <button class="calc-btn number">8</button>
                <button class="calc-btn number">9</button>
                <button class="calc-btn operator" data-action="subtract">-</button>

                <button class="calc-btn number">4</button>
                <button class="calc-btn number">5</button>
                <button class="calc-btn number">6</button>
                <button class="calc-btn operator" data-action="add">+</button>

                <button class="calc-btn number">1</button>
                <button class="calc-btn number">2</button>
                <button class="calc-btn number">3</button>
                <button class="calc-btn equals" data-action="equals">=</button>

                <button class="calc-btn number zero">0</button>
                <button class="calc-btn number decimal">.</button>
                <button class="calc-btn apply-calc" data-action="apply">Apply</button>
            </div>
        </div>

        <nav class="bottom-nav">
            <button class="nav-item active" data-view="dashboard-view">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-item" data-view="add-expense-view">
                <i class="fas fa-plus-circle"></i>
                <span>Add</span>
            </button>
            <button class="nav-item" data-view="categories-view">
                <i class="fas fa-tags"></i>
                <span>Categories</span>
            </button>
            <button class="nav-item" data-view="filtered-transactions-view">
                <i class="fas fa-filter"></i>
                <span>Filter</span>
            </button>
            <button class="nav-item" data-view="borrowed-lent-view">
                <i class="fas fa-hand-holding-dollar"></i> <span>Debts</span>
            </button>
            <button class="nav-item" data-view="budget-view"> <i class="fas fa-chart-pie"></i>
                <span>Budget</span>
            </button>
            </nav>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const appContainer = document.querySelector('.app-container');
            const mainContent = document.querySelector('.main-content');
            const navItems = document.querySelectorAll('.bottom-nav .nav-item');
            const views = document.querySelectorAll('.view');
            const backToDashboardBtns = document.querySelectorAll('.back-to-dashboard-btn');

            // Dashboard elements
            const balanceAmountSpan = document.querySelector('.balance-amount span');
            const recentTransactionList = document.getElementById('recent-transaction-list');
            const noRecentTransactionsMessage = recentTransactionList.querySelector('.no-transactions');

            // Add Transaction elements (formerly Add Expense)
            const transactionForm = document.getElementById('expense-form'); // Retain ID for now
            const transactionIdInput = document.getElementById('expense-id'); // For future edit functionality
            const transactionTypeRadios = document.querySelectorAll('input[name="transaction-type"]'); // NEW
            const transactionAmountInput = document.getElementById('expense-amount');
            const transactionDescriptionInput = document.getElementById('expense-description');
            const transactionDateInput = document.getElementById('expense-date');
            const transactionCategorySelect = document.getElementById('expense-category');
            const saveTransactionBtn = document.getElementById('save-expense-btn'); // Retain ID for now

            // Categories elements
            const categoryListUl = document.getElementById('category-list');
            const newCategoryInput = document.getElementById('new-category-name');
            const addNewCategoryBtn = document.getElementById('add-new-category-btn');

            // Filtered Transactions elements
            const filteredTransactionList = document.getElementById('filtered-transaction-list');
            const noFilteredTransactionsMessage = filteredTransactionList.querySelector('.no-transactions');
            const filterStartDateInput = document.getElementById('filter-start-date');
            const filterEndDateInput = document.getElementById('filter-end-date');
            const filterCategorySelect = document.getElementById('filter-category');
            const filterTypeSelect = document.getElementById('filter-type'); // NEW filter for type
            const applyFilterBtn = document.getElementById('apply-filter-btn');
            const clearFilterBtn = document.getElementById('clear-filter-btn');

            // Borrowed/Lent elements (NEW SECTION)
            const totalLentSpan = document.getElementById('total-lent');
            const totalBorrowedSpan = document.getElementById('total-borrowed');
            const addBorrowLentBtn = document.getElementById('add-borrow-lent-btn');
            const borrowedLentListUl = document.getElementById('borrowed-lent-list');
            const noBorrowedLentRecordsMessage = borrowedLentListUl.querySelector('.no-records');

            // Add/Edit Borrowed/Lent Form elements (NEW FORM)
            const borrowLentForm = document.getElementById('borrow-lent-form');
            const borrowLentIdInput = document.getElementById('borrow-lent-id');
            const borrowLentTypeRadios = document.querySelectorAll('input[name="borrow-lent-type"]');
            const borrowLentAmountInput = document.getElementById('borrow-lent-amount');
            const borrowLentPersonInput = document.getElementById('borrow-lent-person');
            const borrowLentDateInput = document.getElementById('borrow-lent-date');
            const borrowLentNotesInput = document.getElementById('borrow-lent-notes');
            const borrowLentPaidCheckbox = document.getElementById('borrow-lent-paid');
            const saveBorrowLentBtn = document.getElementById('save-borrow-lent-btn');
            const backToBorrowLentBtn = document.querySelector('.back-to-borrow-lent-btn');

            // --- NEW: Budget Section Elements ---
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const currentBudgetMonthDisplay = document.getElementById('current-budget-month');
            const monthlyBudgetGoalInput = document.getElementById('monthly-budget-goal');
            const saveBudgetGoalBtn = document.getElementById('save-budget-goal-btn');
            const displayBudgetGoal = document.getElementById('display-budget-goal');
            const displayTotalExpenses = document.getElementById('display-total-expenses');
            const displayRemainingBudget = document.getElementById('display-remaining-budget');
            const budgetProgressBar = document.getElementById('budget-progress-bar');
            const budgetProgressLabel = document.getElementById('budget-progress-label');
            const budgetCategoryExpensesList = document.getElementById('budget-category-expenses-list');
            const noBudgetCategoryExpensesMessage = budgetCategoryExpensesList.querySelector('.no-categories'); // Renamed from no-transactions to no-categories to be specific for budget


            // Theme toggle
            const themeToggleBtn = document.getElementById('themeToggle');

            // --- Calculator Elements ---
            // NEW: Calculator toggle button in the header
            const calculatorToggleBtn = document.getElementById('calculatorToggle');
            const calculatorContainer = document.getElementById('calculator');
            const calcOutput = document.getElementById('calc-output');
            const calcButtons = calculatorContainer.querySelector('.calculator-buttons');

            let currentInput = '0';
            let firstOperand = null;
            let operator = null;
            let waitingForSecondOperand = false;

            // --- Data Storage (Using localStorage) ---
            // Transaction objects now include a 'type' property ('expense' or 'income')
            let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            let categories = JSON.parse(localStorage.getItem('categories')) || ['Food', 'Transport', 'Study', 'Entertainment', 'Rent', 'Utilities', 'Shopping', 'Others'];
            let borrowedLentRecords = JSON.parse(localStorage.getItem('borrowedLentRecords')) || []; // NEW: for borrowed/lent money
            let currentTheme = localStorage.getItem('theme') || 'light'; // Default theme
            // NEW: Budget related data
            // Store budgets as an object where key is "YYYY-MM" (e.g., "2025-07") and value is the goal amount
            let monthlyBudgets = JSON.parse(localStorage.getItem('monthlyBudgets')) || {};
            let currentBudgetMonth = new Date(); // Tracks the month currently displayed in the budget section

            // --- Global Filtering State for the Filtered Transactions Section ---
            let currentFilter = {
                startDate: null,
                endDate: null,
                category: 'all',
                type: 'all' // NEW: filter by type
            };

            // --- Initial Setup Functions ---

            function initializeApp() {
                applyTheme(currentTheme);
                populateCategorySelects(); // Populate category dropdowns for Add Transaction and Filter
                updateBalance();
                displayRecentTransactions(); // Display recent transactions on dashboard
                // Set today's date for add transaction form
                transactionDateInput.valueAsDate = new Date();
                // Set default filter dates for the filtered section (e.g., current month)
                setDefaultFilterDates();
                // Initialize borrowed/lent section
                updateBorrowedLentSummary();
                displayBorrowedLentRecords();
                borrowLentDateInput.valueAsDate = new Date(); // Default date for borrowed/lent form
                calculatorContainer.style.display = 'none'; // Ensure calculator is hidden on load
                resetCalculator(); // Reset calculator state
                initializeBudgetSection(); // NEW: Initialize budget section
            }

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                    themeToggleBtn.classList.remove('fa-sun');
                    themeToggleBtn.classList.add('fa-moon');
                } else {
                    document.body.classList.remove('dark-theme');
                    themeToggleBtn.classList.remove('fa-moon');
                    themeToggleBtn.classList.add('fa-sun');
                }
                currentTheme = theme;
                localStorage.setItem('theme', theme);
            }

            function switchView(viewId) {
                console.log('Switching to view:', viewId); // Added for debugging
                views.forEach(view => {
                    view.classList.remove('active');
                });
                document.getElementById(viewId).classList.add('active');

                navItems.forEach(item => {
                    if (item.dataset.view === viewId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                // Specific actions on view switch
                if (viewId === 'dashboard-view') {
                    updateBalance();
                    displayRecentTransactions(); // Refresh recent transactions
                } else if (viewId === 'categories-view') {
                    displayCategoriesList(); // Refresh list
                    populateCategorySelects(); // Ensure filter categories are updated after category changes
                } else if (viewId === 'add-expense-view') {
                    resetTransactionForm(); // Clear form
                    populateCategorySelects(); // Refresh categories
                    // Calculator state is now independent of this view
                } else if (viewId === 'filtered-transactions-view') {
                    populateCategorySelects(); // Ensure filter categories are updated
                    displayFilteredTransactions(); // Initial display of filtered transactions
                } else if (viewId === 'borrowed-lent-view') { // NEW
                    updateBorrowedLentSummary();
                    displayBorrowedLentRecords();
                } else if (viewId === 'add-borrow-lent-view') { // NEW
                    resetBorrowLentForm();
                } else if (viewId === 'budget-view') { // NEW: Budget View Activation
                    updateBudgetDisplay();
                }
            }

            function updateBalance() {
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                balanceAmountSpan.textContent = (totalIncome - totalExpenses).toFixed(2);
            }

            // --- Transaction Functions (now handles Income and Expense) ---

            function populateCategorySelects() {
                // Populate Add Transaction form category select
                transactionCategorySelect.innerHTML = '<option value="">Select a category</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    transactionCategorySelect.appendChild(option);
                });

                // Populate Filtered Transactions category select
                filterCategorySelect.innerHTML = '<option value="all">All Categories</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    filterCategorySelect.appendChild(option);
                });
                // Restore previous filter selection if it exists
                filterCategorySelect.value = currentFilter.category;
            }

            // Function to display transactions (used by both recent and filtered lists)
            function renderTransactionList(targetListElement, transactionsToDisplay, noTransactionsMsgElement) {
                targetListElement.innerHTML = ''; // Clear existing list

                // Show/hide "No transactions" message
                if (transactionsToDisplay.length === 0) {
                    if (noTransactionsMsgElement) {
                        noTransactionsMsgElement.style.display = 'block';
                    }
                    return;
                } else {
                    if (noTransactionsMsgElement) {
                        noTransactionsMsgElement.style.display = 'none';
                    }
                }

                // Sort by date descending for recent/filtered lists
                const sortedTransactions = [...transactionsToDisplay].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedTransactions.forEach(transaction => {
                    const li = document.createElement('li');
                    li.className = `transaction-item ${transaction.type}`; // Add 'expense' or 'income' class
                    li.dataset.id = transaction.id; // Store ID for deletion/editing

                    const transactionDate = new Date(transaction.date);
                    const formattedDate = transactionDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });

                    // Determine icon based on type
                    const iconClass = transaction.type === 'expense' ? 'fa-minus-circle' : 'fa-plus-circle';

                    li.innerHTML = `
                        <div class="transaction-icon"><i class="fas ${iconClass}"></i></div>
                        <div class="transaction-info">
                            <div class="transaction-description">${transaction.description}</div>
                            <div class="transaction-details">
                                <span class="transaction-date">${formattedDate}</span>
                                <span class="transaction-category"> - ${transaction.category}</span>
                            </div>
                        </div>
                        <div class="transaction-amount">₹ ${parseFloat(transaction.amount).toFixed(2)}</div>
                        <div class="transaction-actions">
                            <button class="edit-transaction-btn"><i class="fas fa-edit"></i></button>
                            <button class="delete-transaction-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    targetListElement.appendChild(li);
                });
            }

            function displayRecentTransactions() {
                // Display only the last 5 transactions on the dashboard
                const recentTrans = [...transactions]
                                        .sort((a, b) => new Date(b.date) - new Date(a.date))
                                        .slice(0, 5);
                renderTransactionList(recentTransactionList, recentTrans, noRecentTransactionsMessage);
                // Ensure the no transactions message is handled correctly if no recent transactions
                if (recentTrans.length === 0 && !recentTransactionList.contains(noRecentTransactionsMessage)) {
                    recentTransactionList.appendChild(noRecentTransactionsMessage);
                    noRecentTransactionsMessage.style.display = 'block';
                }
            }


            function saveTransaction(e) {
                e.preventDefault();

                const id = transactionIdInput.value ? parseInt(transactionIdInput.value) : null;
                const type = document.querySelector('input[name="transaction-type"]:checked').value; // Get selected type
                const amount = parseFloat(transactionAmountInput.value);
                const description = transactionDescriptionInput.value.trim();
                const date = transactionDateInput.value;
                const category = transactionCategorySelect.value;

                if (isNaN(amount) || amount <= 0 || description === '' || date === '' || category === '') {
                    alert('Please fill in all fields with valid data.');
                    return;
                }

                if (id) { // Editing existing transaction
                    transactions = transactions.map(t =>
                        t.id === id
                            ? { ...t, type, amount, description, date, category } // Update type too
                            : t
                    );
                    alert('Transaction updated successfully!');
                } else { // Adding new transaction
                    const newTransaction = {
                        id: Date.now(), // Simple unique ID
                        type: type, // Store the type
                        amount: amount,
                        description: description,
                        date: date,
                        category: category
                    };
                    transactions.unshift(newTransaction); // Add to the beginning to show as recent
                    alert('Transaction added successfully!');
                }

                localStorage.setItem('transactions', JSON.stringify(transactions));
                resetTransactionForm();
                switchView('dashboard-view'); // Go back to dashboard
                updateBudgetDisplay(); // Update budget display if needed
            }

            function deleteTransaction(id) {
                if (confirm('Are you sure you want to delete this transaction?')) {
                    transactions = transactions.filter(t => t.id !== id);
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                    updateBalance();
                    displayRecentTransactions(); // Refresh recent list
                    if (document.getElementById('filtered-transactions-view').classList.contains('active')) {
                        displayFilteredTransactions(); // Refresh filtered list if active
                    }
                    if (document.getElementById('budget-view').classList.contains('active')) { // NEW
                        updateBudgetDisplay();
                    }
                }
            }

            // Function to handle editing, works for both recent and filtered lists
            function editTransaction(id) {
                const transactionToEdit = transactions.find(t => t.id === id);
                if (transactionToEdit) {
                    transactionIdInput.value = transactionToEdit.id;
                    // Set transaction type radio button
                    document.getElementById(`type-${transactionToEdit.type}`).checked = true;
                    transactionAmountInput.value = transactionToEdit.amount;
                    transactionDescriptionInput.value = transactionToEdit.description;
                    transactionDateInput.value = transactionToEdit.date;
                    transactionCategorySelect.value = transactionToEdit.category;

                    document.getElementById('add-expense-view').querySelector('.section-title').textContent = 'Edit Transaction';
                    saveTransactionBtn.textContent = 'Update Transaction';
                    switchView('add-expense-view');
                }
            }

            function resetTransactionForm() {
                transactionForm.reset();
                transactionIdInput.value = '';
                document.getElementById('add-expense-view').querySelector('.section-title').textContent = 'Add New Transaction';
                saveTransactionBtn.textContent = 'Add Transaction';
                transactionDateInput.valueAsDate = new Date(); // Reset date to today
                document.getElementById('type-expense').checked = true; // Default to expense
                populateCategorySelects(); // Repopulate categories just in case
            }

            // --- Transaction Filtering for dedicated section ---
            function setDefaultFilterDates() {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                filterStartDateInput.valueAsDate = firstDayOfMonth;
                filterEndDateInput.valueAsDate = lastDayOfMonth;

                // Initialize currentFilter with these defaults
                currentFilter.startDate = firstDayOfMonth.toISOString().split('T')[0];
                currentFilter.endDate = lastDayOfMonth.toISOString().split('T')[0];
                filterTypeSelect.value = 'all'; // Default filter type
            }

            function applyFiltersAndDisplay() {
                currentFilter.startDate = filterStartDateInput.value;
                currentFilter.endDate = filterEndDateInput.value;
                currentFilter.category = filterCategorySelect.value;
                currentFilter.type = filterTypeSelect.value; // Get filter type
                displayFilteredTransactions();
            }

            function clearAllFilters() {
                filterStartDateInput.value = '';
                filterEndDateInput.value = '';
                filterCategorySelect.value = 'all';
                filterTypeSelect.value = 'all'; // Clear filter type

                currentFilter.startDate = null;
                currentFilter.endDate = null;
                currentFilter.category = 'all';
                currentFilter.type = 'all'; // Clear filter type
                displayFilteredTransactions();
            }

            function displayFilteredTransactions() {
                let filteredTransactions = [...transactions];

                // Filter by Date Range
                const startDate = currentFilter.startDate;
                const endDate = currentFilter.endDate;
                if (startDate) {
                    const startOfDay = new Date(startDate);
                    startOfDay.setHours(0, 0, 0, 0);
                    filteredTransactions = filteredTransactions.filter(t => new Date(t.date) >= startOfDay);
                }
                if (endDate) {
                    const endOfDay = new Date(endDate);
                    endOfDay.setHours(23, 59, 59, 999);
                    filteredTransactions = filteredTransactions.filter(t => new Date(t.date) <= endOfDay);
                }

                // Filter by Category
                if (currentFilter.category !== 'all') {
                    filteredTransactions = filteredTransactions.filter(t => t.category === currentFilter.category);
                }

                // Filter by Type (NEW)
                if (currentFilter.type !== 'all') {
                    filteredTransactions = filteredTransactions.filter(t => t.type === currentFilter.type);
                }

                renderTransactionList(filteredTransactionList, filteredTransactions, noFilteredTransactionsMessage);
                // Ensure the no transactions message is handled correctly if no filtered transactions
                if (filteredTransactions.length === 0 && !filteredTransactionList.contains(noFilteredTransactionsMessage)) {
                    filteredTransactionList.appendChild(noFilteredTransactionsMessage);
                    noFilteredTransactionsMessage.style.display = 'block';
                }
            }


            // --- Category Functions ---
            function displayCategoriesList() {
                categoryListUl.innerHTML = '';
                if (categories.length === 0) {
                    const noCategoriesLi = document.createElement('li');
                    noCategoriesLi.textContent = 'No categories added yet.';
                    categoryListUl.appendChild(noCategoriesLi);
                    return;
                }
                categories.forEach(category => {
                    const li = document.createElement('li');
                    li.className = 'category-item';
                    li.dataset.categoryName = category; // Store name for operations
                    li.innerHTML = `
                        <span>${category}</span>
                        <div class="action-buttons">
                            <button class="edit-category-btn"><i class="fas fa-edit"></i></button>
                            <button class="delete-category-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    categoryListUl.appendChild(li);
                });
            }

            function addCategory() {
                const newCatName = newCategoryInput.value.trim();
                if (newCatName && !categories.includes(newCatName)) {
                    categories.push(newCatName);
                    localStorage.setItem('categories', JSON.stringify(categories));
                    newCategoryInput.value = '';
                    displayCategoriesList();
                    populateCategorySelects(); // Update all relevant selects
                    alert(`Category "${newCatName}" added!`);
                } else if (newCatName && categories.includes(newCatName)) {
                    alert('Category already exists!');
                }
            }

            function deleteCategory(categoryName) {
                if (confirm(`Are you sure you want to delete the category "${categoryName}"? Existing transactions assigned to it will appear without a valid category.`)) {
                    categories = categories.filter(cat => cat !== categoryName);
                    localStorage.setItem('categories', JSON.stringify(categories));
                    displayCategoriesList();
                    populateCategorySelects(); // Update all relevant selects
                    displayRecentTransactions(); // Refresh dashboard in case a category was used
                    if (document.getElementById('filtered-transactions-view').classList.contains('active')) {
                        displayFilteredTransactions(); // Refresh filtered list if active
                    }
                    if (document.getElementById('budget-view').classList.contains('active')) { // NEW
                        updateBudgetDisplay();
                    }
                }
            }

            function editCategory(oldCategoryName) {
                const newCategoryName = prompt(`Edit category "${oldCategoryName}":`, oldCategoryName);
                if (newCategoryName && newCategoryName.trim() !== '' && newCategoryName.trim() !== oldCategoryName) {
                    const trimmedNewName = newCategoryName.trim();
                    if (categories.includes(trimmedNewName)) {
                        alert('A category with this name already exists.');
                        return;
                    }
                    // Update the category in the array
                    const index = categories.indexOf(oldCategoryName);
                    if (index > -1) {
                        categories[index] = trimmedNewName;
                        localStorage.setItem('categories', JSON.stringify(categories));

                        // Update transactions that used the old category name
                        transactions.forEach(t => {
                            if (t.category === oldCategoryName) {
                                t.category = trimmedNewName;
                            }
                        });
                        localStorage.setItem('transactions', JSON.stringify(transactions));

                        displayCategoriesList();
                        populateCategorySelects();
                        displayRecentTransactions(); // Refresh dashboard if needed
                         if (document.getElementById('filtered-transactions-view').classList.contains('active')) {
                            displayFilteredTransactions(); // Refresh filtered list if active
                        }
                        if (document.getElementById('budget-view').classList.contains('active')) { // NEW
                            updateBudgetDisplay();
                        }
                        alert(`Category updated to "${trimmedNewName}"!`);
                    }
                }
            }

            // --- Borrowed/Lent Money Functions (NEW) ---

            function updateBorrowedLentSummary() {
                const totalLent = borrowedLentRecords.filter(r => r.type === 'lent' && !r.paid).reduce((sum, r) => sum + parseFloat(r.amount), 0);
                const totalBorrowed = borrowedLentRecords.filter(r => r.type === 'borrowed' && !r.paid).reduce((sum, r) => sum + parseFloat(r.amount), 0);

                totalLentSpan.textContent = totalLent.toFixed(2);
                totalBorrowedSpan.textContent = totalBorrowed.toFixed(2);
            }

            function displayBorrowedLentRecords() {
                borrowedLentListUl.innerHTML = '';
                if (borrowedLentRecords.length === 0) {
                    if (!borrowedLentListUl.contains(noBorrowedLentRecordsMessage)) {
                        borrowedLentListUl.appendChild(noBorrowedLentRecordsMessage);
                    }
                    noBorrowedLentRecordsMessage.style.display = 'block';
                    return;
                } else {
                    noBorrowedLentRecordsMessage.style.display = 'none';
                }

                // Sort by date descending
                const sortedRecords = [...borrowedLentRecords].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedRecords.forEach(record => {
                    const li = document.createElement('li');
                    li.className = `borrowed-lent-item ${record.type} ${record.paid ? 'paid' : ''}`;
                    li.dataset.id = record.id;

                    const recordDate = new Date(record.date);
                    const formattedDate = recordDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });

                    const typeLabel = record.type === 'lent' ? 'Lent to' : 'Borrowed from';
                    const statusLabel = record.paid ? '(Paid/Returned)' : '';
                    const statusIcon = record.paid ? '<i class="fas fa-check-circle paid-btn active"></i>' : '<i class="fas fa-money-bill-transfer paid-btn"></i>'; // Icon for marking as paid

                    li.innerHTML = `
                        <div class="borrowed-lent-info">
                            <div class="borrowed-lent-person">${typeLabel} ${record.person} ${statusLabel}</div>
                            <div class="borrowed-lent-details">
                                <span>${formattedDate}</span>
                                ${record.notes ? `<span class="borrowed-lent-notes">${record.notes}</span>` : ''}
                            </div>
                        </div>
                        <div class="borrowed-lent-amount">₹ ${parseFloat(record.amount).toFixed(2)}</div>
                        <div class="borrowed-lent-actions">
                            <button class="mark-paid-btn" title="Mark as Paid/Returned">${statusIcon}</button>
                            <button class="edit-borrow-lent-btn" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="delete-borrow-lent-btn" title="Delete"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    borrowedLentListUl.appendChild(li);
                });
            }

            function saveBorrowedLentRecord(e) {
                e.preventDefault();

                const id = borrowLentIdInput.value ? parseInt(borrowLentIdInput.value) : null;
                const type = document.querySelector('input[name="borrow-lent-type"]:checked').value;
                const amount = parseFloat(borrowLentAmountInput.value);
                const person = borrowLentPersonInput.value.trim();
                const date = borrowLentDateInput.value;
                const notes = borrowLentNotesInput.value.trim();
                const paid = borrowLentPaidCheckbox.checked;

                if (isNaN(amount) || amount <= 0 || person === '' || date === '') {
                    alert('Please fill in all required fields for the record.');
                    return;
                }

                if (id) { // Editing existing record
                    borrowedLentRecords = borrowedLentRecords.map(r =>
                        r.id === id
                            ? { ...r, type, amount, person, date, notes, paid }
                            : r
                    );
                    alert('Record updated successfully!');
                } else { // Adding new record
                    const newRecord = {
                        id: Date.now(),
                        type,
                        amount,
                        person,
                        date,
                        notes,
                        paid // Store initial paid status
                    };
                    borrowedLentRecords.unshift(newRecord); // Add to the beginning
                    alert('Record added successfully!');
                }

                localStorage.setItem('borrowedLentRecords', JSON.stringify(borrowedLentRecords));
                resetBorrowLentForm();
                switchView('borrowed-lent-view'); // Go back to borrowed/lent list
            }

            function deleteBorrowedLentRecord(id) {
                if (confirm('Are you sure you want to delete this borrowed/lent record?')) {
                    borrowedLentRecords = borrowedLentRecords.filter(r => r.id !== id);
                    localStorage.setItem('borrowedLentRecords', JSON.stringify(borrowedLentRecords));
                    updateBorrowedLentSummary();
                    displayBorrowedLentRecords();
                }
            }

            function editBorrowedLentRecord(id) {
                const recordToEdit = borrowedLentRecords.find(r => r.id === id);
                if (recordToEdit) {
                    borrowLentIdInput.value = recordToEdit.id;
                    document.getElementById(`type-${recordToEdit.type}`).checked = true;
                    borrowLentAmountInput.value = recordToEdit.amount;
                    borrowLentPersonInput.value = recordToEdit.person;
                    borrowLentDateInput.value = recordToEdit.date;
                    borrowLentNotesInput.value = recordToEdit.notes;
                    borrowLentPaidCheckbox.checked = recordToEdit.paid;

                    document.getElementById('add-borrow-lent-view').querySelector('.section-title').textContent = 'Edit Money Record';
                    saveBorrowLentBtn.textContent = 'Update Record';
                    switchView('add-borrow-lent-view');
                }
            }

            function toggleBorrowedLentPaidStatus(id) {
                borrowedLentRecords = borrowedLentRecords.map(r =>
                    r.id === id ? { ...r, paid: !r.paid } : r
                );
                localStorage.setItem('borrowedLentRecords', JSON.stringify(borrowedLentRecords));
                updateBorrowedLentSummary();
                displayBorrowedLentRecords();
            }


            function resetBorrowLentForm() {
                borrowLentForm.reset();
                borrowLentIdInput.value = '';
                document.getElementById('add-borrow-lent-view').querySelector('.section-title').textContent = 'Add New Money Record';
                saveBorrowLentBtn.textContent = 'Save Record';
                document.getElementById('type-lent').checked = true; // Default to Money Lent
                borrowLentDateInput.valueAsDate = new Date();
            }

            // --- NEW: Budget Section Functions ---

            function initializeBudgetSection() {
                // Set currentBudgetMonth to the current month by default
                currentBudgetMonth = new Date();
                updateBudgetDisplay();
            }

            function getMonthYearString(date) {
                const options = { year: 'numeric', month: 'long' };
                return date.toLocaleDateString('en-US', options); // e.g., "July 2025"
            }

            function getBudgetKey(date) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0'); // 0-indexed month, pad with leading zero
                return `${year}-${month}`; // e.g., "2025-07"
            }

            function updateBudgetDisplay() {
                const monthYearStr = getMonthYearString(currentBudgetMonth);
                currentBudgetMonthDisplay.textContent = monthYearStr;

                const budgetKey = getBudgetKey(currentBudgetMonth);
                const budgetGoal = monthlyBudgets[budgetKey] || 0; // Default to 0 if no budget set

                monthlyBudgetGoalInput.value = budgetGoal > 0 ? budgetGoal : ''; // Set input field, clear if 0
                displayBudgetGoal.textContent = parseFloat(budgetGoal).toFixed(2);

                // Calculate expenses for the current month
                const expensesForMonth = transactions.filter(t => {
                    if (t.type !== 'expense') return false; // Only count expenses
                    const transactionDate = new Date(t.date);
                    return transactionDate.getFullYear() === currentBudgetMonth.getFullYear() &&
                           transactionDate.getMonth() === currentBudgetMonth.getMonth();
                });

                const totalExpenses = expensesForMonth.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                displayTotalExpenses.textContent = totalExpenses.toFixed(2);

                const remainingBudget = budgetGoal - totalExpenses;
                displayRemainingBudget.textContent = remainingBudget.toFixed(2);

                // Apply color based on remaining budget
                if (remainingBudget >= 0) {
                    displayRemainingBudget.classList.remove('negative');
                    displayRemainingBudget.classList.add('positive');
                } else {
                    displayRemainingBudget.classList.remove('positive');
                    displayRemainingBudget.classList.add('negative');
                }

                // Update progress bar
                let percentageUsed = 0;
                if (budgetGoal > 0) {
                    percentageUsed = (totalExpenses / budgetGoal) * 100;
                }
                // Cap percentage at 100% for display purposes on the bar
                const progressBarWidth = Math.min(percentageUsed, 100);
                budgetProgressBar.style.width = `${progressBarWidth}%`;

                // Change progress bar color based on percentage
                if (percentageUsed <= 50) {
                    budgetProgressBar.style.backgroundColor = '#4CAF50'; // Green
                } else if (percentageUsed <= 80) {
                    budgetProgressBar.style.backgroundColor = '#ffc107'; // Yellow
                } else {
                    budgetProgressBar.style.backgroundColor = '#f44336'; // Red
                }

                budgetProgressLabel.textContent = `${percentageUsed.toFixed(0)}% of budget used`;

                // Display expenses by category for the month
                displayCategoryExpensesForMonth(expensesForMonth);
            }

            function displayCategoryExpensesForMonth(expenses) {
                budgetCategoryExpensesList.innerHTML = '';
                const categoryTotals = {};

                expenses.forEach(t => {
                    if (categoryTotals[t.category]) {
                        categoryTotals[t.category] += parseFloat(t.amount);
                    } else {
                        categoryTotals[t.category] = parseFloat(t.amount);
                    }
                });

                const sortedCategories = Object.keys(categoryTotals).sort((a, b) => categoryTotals[b] - categoryTotals[a]);

                if (sortedCategories.length === 0) {
                    if (!budgetCategoryExpensesList.contains(noBudgetCategoryExpensesMessage)) {
                        budgetCategoryExpensesList.appendChild(noBudgetCategoryExpensesMessage);
                    }
                    noBudgetCategoryExpensesMessage.style.display = 'block';
                    return;
                } else {
                    noBudgetCategoryExpensesMessage.style.display = 'none';
                }

                sortedCategories.forEach(category => {
                    const li = document.createElement('li');
                    li.className = 'category-summary-item';
                    li.innerHTML = `
                        <span>${category}</span>
                        <span>₹ ${categoryTotals[category].toFixed(2)}</span>
                    `;
                    budgetCategoryExpensesList.appendChild(li);
                });
            }

            function saveMonthlyBudgetGoal() {
                let goal = parseFloat(monthlyBudgetGoalInput.value);
                if (isNaN(goal) || goal < 0) {
                    goal = 0; // Set to 0 if invalid input
                }

                const budgetKey = getBudgetKey(currentBudgetMonth);
                monthlyBudgets[budgetKey] = goal;
                localStorage.setItem('monthlyBudgets', JSON.stringify(monthlyBudgets));
                updateBudgetDisplay();
                alert('Monthly budget goal saved!');
            }

            function changeBudgetMonth(direction) {
                // direction: -1 for previous, 1 for next
                currentBudgetMonth.setMonth(currentBudgetMonth.getMonth() + direction);
                updateBudgetDisplay();
            }

            // --- Calculator Functions ---

            function inputDigit(digit) {
                const displayValue = calcOutput.value;
                if (waitingForSecondOperand === true) {
                    calcOutput.value = digit;
                    currentInput = digit;
                    waitingForSecondOperand = false;
                } else {
                    calcOutput.value = displayValue === '0' ? digit : displayValue + digit;
                    currentInput = calcOutput.value;
                }
            }

            function inputDecimal(dot) {
                if (waitingForSecondOperand === true) {
                    calcOutput.value = '0.';
                    currentInput = '0.';
                    waitingForSecondOperand = false;
                    return;
                }
                if (!calcOutput.value.includes(dot)) {
                    calcOutput.value += dot;
                    currentInput = calcOutput.value;
                }
            }

            function handleOperator(nextOperator) {
                const inputValue = parseFloat(currentInput);

                if (operator && waitingForSecondOperand) {
                    operator = nextOperator;
                    return;
                }

                if (firstOperand === null) {
                    firstOperand = inputValue;
                } else if (operator) {
                    const result = operate(firstOperand, inputValue, operator);
                    calcOutput.value = parseFloat(result.toFixed(5)); // Limit decimals
                    currentInput = calcOutput.value;
                    firstOperand = parseFloat(result.toFixed(5));
                }

                waitingForSecondOperand = true;
                operator = nextOperator;
            }

            function operate(num1, num2, op) {
                if (op === '+') return num1 + num2;
                if (op === '-') return num1 - num2;
                if (op === '*') return num1 * num2;
                if (op === '/') {
                    if (num2 === 0) {
                        alert("Cannot divide by zero!");
                        return 0; // Or handle as an error state
                    }
                    return num1 / num2;
                }
                return num2; // For equals, if no operator pending
            }

            function resetCalculator() {
                currentInput = '0';
                firstOperand = null;
                operator = null;
                waitingForSecondOperand = false;
                calcOutput.value = '0';
            }

            function backspaceCalculator() {
                if (calcOutput.value.length === 1) {
                    calcOutput.value = '0';
                    currentInput = '0';
                } else {
                    calcOutput.value = calcOutput.value.slice(0, -1);
                    currentInput = calcOutput.value;
                }
            }

            function applyCalculatorResult() {
                // Check if the "Add Transaction" view is active
                const addTransactionView = document.getElementById('add-expense-view');
                if (addTransactionView.classList.contains('active')) {
                    transactionAmountInput.value = parseFloat(calcOutput.value);
                } else {
                    // If not in add transaction view, you might want to:
                    // 1. Show an alert that it only applies to the amount field
                    // 2. Do nothing
                    // 3. (More complex) Apply to a currently active input field if one is focused
                    alert("Calculator result applied to the 'Amount' field in the Add Transaction section.");
                    // Or, if you want it to always apply to expense-amount when apply is pressed:
                    // transactionAmountInput.value = parseFloat(calcOutput.value);
                }
                calculatorContainer.style.display = 'none'; // Hide calculator after applying
                resetCalculator(); // Reset calculator for next use
            }


            // --- Event Listeners ---

            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const viewId = item.dataset.view;
                    if (viewId) {
                        switchView(viewId);
                    }
                });
            });

            // Back to Dashboard buttons
            backToDashboardBtns.forEach(btn => {
                btn.addEventListener('click', () => switchView('dashboard-view'));
            });

            // Back to Borrowed/Lent List (NEW)
            backToBorrowLentBtn.addEventListener('click', () => switchView('borrowed-lent-view'));


            // Transaction Form Submission
            transactionForm.addEventListener('submit', saveTransaction);

            // Delete/Edit Transaction (Event delegation for dynamically added items)
            recentTransactionList.addEventListener('click', (e) => {
                const targetBtn = e.target.closest('button');
                if (!targetBtn) return;
                const li = targetBtn.closest('.transaction-item');
                if (!li) return;
                const id = parseInt(li.dataset.id);

                if (targetBtn.classList.contains('delete-transaction-btn')) {
                    deleteTransaction(id);
                } else if (targetBtn.classList.contains('edit-transaction-btn')) {
                    editTransaction(id);
                }
            });

            filteredTransactionList.addEventListener('click', (e) => {
                const targetBtn = e.target.closest('button');
                if (!targetBtn) return;
                const li = targetBtn.closest('.transaction-item');
                if (!li) return;
                const id = parseInt(li.dataset.id);

                if (targetBtn.classList.contains('delete-transaction-btn')) {
                    deleteTransaction(id);
                } else if (targetBtn.classList.contains('edit-transaction-btn')) {
                    editTransaction(id);
                }
            });


            // Transaction Filtering for dedicated section
            applyFilterBtn.addEventListener('click', applyFiltersAndDisplay);
            clearFilterBtn.addEventListener('click', clearAllFilters);
            filterCategorySelect.addEventListener('change', applyFiltersAndDisplay);
            filterStartDateInput.addEventListener('change', applyFiltersAndDisplay);
            filterEndDateInput.addEventListener('change', applyFiltersAndDisplay);
            filterTypeSelect.addEventListener('change', applyFiltersAndDisplay); // NEW: Listen to type filter

            // Add New Category
            addNewCategoryBtn.addEventListener('click', addCategory);

            // Edit/Delete Category (Event delegation)
            categoryListUl.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;

                const li = target.closest('.category-item');
                if (!li) return;

                const categoryName = li.dataset.categoryName;

                if (target.classList.contains('delete-category-btn')) {
                    deleteCategory(categoryName);
                } else if (target.classList.contains('edit-category-btn')) {
                    editCategory(categoryName);
                }
            });

            // Borrowed/Lent Money Event Listeners (NEW)
            addBorrowLentBtn.addEventListener('click', () => switchView('add-borrow-lent-view'));
            borrowLentForm.addEventListener('submit', saveBorrowedLentRecord);
            borrowedLentListUl.addEventListener('click', (e) => {
                const targetBtn = e.target.closest('button');
                if (!targetBtn) return;
                const li = targetBtn.closest('.borrowed-lent-item');
                if (!li) return;
                const id = parseInt(li.dataset.id);

                if (targetBtn.classList.contains('delete-borrow-lent-btn')) {
                    deleteBorrowedLentRecord(id);
                } else if (targetBtn.classList.contains('edit-borrow-lent-btn')) {
                    editBorrowedLentRecord(id);
                } else if (targetBtn.classList.contains('mark-paid-btn')) {
                    toggleBorrowedLentPaidStatus(id);
                }
            });

            // --- NEW: Budget Section Event Listeners ---
            prevMonthBtn.addEventListener('click', () => changeBudgetMonth(-1));
            nextMonthBtn.addEventListener('click', () => changeBudgetMonth(1));
            saveBudgetGoalBtn.addEventListener('click', saveMonthlyBudgetGoal);
            monthlyBudgetGoalInput.addEventListener('keydown', (e) => { // Allow pressing Enter to save budget
                if (e.key === 'Enter') {
                    saveMonthlyBudgetGoal();
                }
            });

            // Theme Toggle
            themeToggleBtn.addEventListener('click', () => {
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(newTheme);
            });

            // --- Calculator Event Listeners ---
            // NEW: Event listener for the global calculator toggle button
            calculatorToggleBtn.addEventListener('click', () => {
                // Toggle visibility
                if (calculatorContainer.style.display === 'none') {
                    calculatorContainer.style.display = 'block';
                    // If an amount input is active, copy its value to the calculator
                    if (document.getElementById('add-expense-view').classList.contains('active')) {
                        if (transactionAmountInput.value) {
                            currentInput = transactionAmountInput.value;
                            calcOutput.value = transactionAmountInput.value;
                        } else {
                            resetCalculator();
                        }
                    } else if (document.getElementById('add-borrow-lent-view').classList.contains('active')) {
                         if (borrowLentAmountInput.value) {
                            currentInput = borrowLentAmountInput.value;
                            calcOutput.value = borrowLentAmountInput.value;
                        } else {
                            resetCalculator();
                        }
                    } else {
                        resetCalculator(); // Reset if no amount input field is directly active
                    }

                } else {
                    calculatorContainer.style.display = 'none';
                    resetCalculator(); // Always reset when closing
                }
            });

            calcButtons.addEventListener('click', (e) => {
                const target = e.target;
                if (!target.matches('button')) return; // Ensure it's a button

                const value = target.textContent;
                const action = target.dataset.action;

                if (target.classList.contains('number') || target.classList.contains('decimal')) {
                    inputDigit(value);
                } else if (target.classList.contains('operator')) {
                    handleOperator(value);
                } else if (action === 'clear') {
                    resetCalculator();
                } else if (action === 'backspace') {
                    backspaceCalculator();
                } else if (action === 'equals') {
                    if (firstOperand !== null && operator !== null && !waitingForSecondOperand) {
                        const result = operate(firstOperand, parseFloat(currentInput), operator);
                        calcOutput.value = parseFloat(result.toFixed(5));
                        currentInput = calcOutput.value;
                        firstOperand = null; // Clear for next calculation
                        operator = null;
                        waitingForSecondOperand = true; // Ready for new operation or number
                    }
                } else if (action === 'apply') {
                    // Modified apply logic to check which amount field is active
                    if (document.getElementById('add-expense-view').classList.contains('active')) {
                        transactionAmountInput.value = parseFloat(calcOutput.value);
                    } else if (document.getElementById('add-borrow-lent-view').classList.contains('active')) {
                        borrowLentAmountInput.value = parseFloat(calcOutput.value);
                    } else {
                        alert("Calculator result can only be applied to the 'Amount' field when adding/editing a transaction or borrowed/lent record.");
                    }
                    calculatorContainer.style.display = 'none'; // Hide calculator after applying
                    resetCalculator(); // Reset calculator for next use
                }
            });


            // --- Initialize on Load ---
            initializeApp();
        });
    </script>
</body>
</html>
