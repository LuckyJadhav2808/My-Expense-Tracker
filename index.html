<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Expense Tracker</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <i class="fas fa-sun toggle-theme-btn" id="themeToggle"></i>
            </div>
            <div class="header-center">
                <h1 class="app-title">Expense Tracker</h1>
            </div>
            <div class="header-right">
                <i class="fas fa-calculator toggle-calculator-btn" id="calculatorToggle"></i>
            </div>
        </header>

        <main class="main-content">
            <section id="dashboard-view" class="view active">
                <div class="balance-card">
                    <p class="balance-label">Current Balance</p>
                    <p class="balance-amount">₹ <span>0.00</span></p>
                </div>

                <div class="quick-actions">
                    <button class="action-btn" data-view="add-expense-view">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add New</span>
                    </button>
                    </div>

                <h2 class="section-title">Recent Transactions</h2>
                <ul class="transaction-list" id="recent-transaction-list">
                    <li class="no-transactions">No transactions yet! Add one to get started.</li>
                </ul>
            </section>

            <section id="add-expense-view" class="view">
                <h2 class="section-title">Add New Transaction</h2>
                <form id="expense-form" class="expense-form">
                    <input type="hidden" id="expense-id">
                    <div class="form-group">
                        <label for="transaction-type">Transaction Type</label>
                        <div class="transaction-type-selector">
                            <input type="radio" id="type-expense" name="transaction-type" value="expense" checked>
                            <label for="type-expense">Expense</label>
                            <input type="radio" id="type-income" name="transaction-type" value="income">
                            <label for="type-income">Income</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="expense-amount">Amount</label>
                        <input type="number" id="expense-amount" placeholder="e.g., 500" required step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="expense-description">Description</label>
                        <input type="text" id="expense-description" placeholder="e.g., Dinner with friends" required>
                    </div>
                     <div class="form-group">
                        <label for="expense-date">Date</label>
                        <input type="date" id="expense-date" value="" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-category">Category</label>
                        <select id="expense-category" required>
                            <option value="">Select a category</option>
                        </select>
                    </div>
                    <button type="submit" class="primary-btn" id="save-expense-btn">Add Transaction</button>
                    <button type="button" class="secondary-btn back-to-dashboard-btn">Cancel</button>
                </form>
            </section>

            <section id="categories-view" class="view">
                <h2 class="section-title">Manage Categories</h2>
                <ul id="category-list" class="category-list">
                    </ul>
                <div class="add-category-section">
                    <input type="text" id="new-category-name" placeholder="New category name" class="new-category-input">
                    <button id="add-new-category-btn" class="primary-btn">Add Category</button>
                </div>
                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

            <section id="filtered-transactions-view" class="view">
                <h2 class="section-title">Filtered Transactions</h2>
                <div class="transaction-filters">
                    <input type="date" id="filter-start-date" placeholder="From Date">
                    <input type="date" id="filter-end-date" placeholder="To Date">
                    <select id="filter-category">
                        <option value="all">All Categories</option>
                        </select>
                    <select id="filter-type">
                        <option value="all">All Types</option>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                    <button class="secondary-btn small-btn" id="apply-filter-btn">Apply Filters</button>
                    <button class="secondary-btn small-btn" id="clear-filter-btn">Clear Filters</button>
                </div>
                <ul class="transaction-list" id="filtered-transaction-list">
                    <li class="no-transactions">Apply filters to see transactions.</li>
                </ul>
                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

            <section id="borrowed-lent-view" class="view">
                <h2 class="section-title">Borrowed/Lent Money</h2>
                <div class="summary-cards">
                    <div class="summary-card owed">
                        <h3>Money Owed to You</h3>
                        <p class="amount">₹ <span id="total-lent">0.00</span></p>
                    </div>
                    <div class="summary-card owing">
                        <h3>Money You Owe</h3>
                        <p class="amount">₹ <span id="total-borrowed">0.00</span></p>
                    </div>
                </div>

                <button class="primary-btn" id="add-borrow-lent-btn">Add Record</button>

                <h3 class="subsection-title">All Records</h3>
                <ul class="borrowed-lent-list" id="borrowed-lent-list">
                    <li class="no-records">No borrowed/lent records yet.</li>
                </ul>
                 <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

            <section id="add-borrow-lent-view" class="view">
                <h2 class="section-title">Add/Edit Money Record</h2>
                <form id="borrow-lent-form" class="expense-form">
                    <input type="hidden" id="borrow-lent-id">
                    <div class="form-group">
                        <label for="borrow-lent-type">Record Type</label>
                        <div class="transaction-type-selector">
                            <input type="radio" id="type-lent" name="borrow-lent-type" value="lent" checked>
                            <label for="type-lent">Money Lent</label>
                            <input type="radio" id="type-borrowed" name="borrow-lent-type" value="borrowed">
                            <label for="type-borrowed">Money Borrowed</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-amount">Amount</label>
                        <input type="number" id="borrow-lent-amount" placeholder="e.g., 200" required step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-person">Person/Party</label>
                        <input type="text" id="borrow-lent-person" placeholder="e.g., John Doe" required>
                    </div>
                     <div class="form-group">
                        <label for="borrow-lent-date">Date</label>
                        <input type="date" id="borrow-lent-date" value="" required>
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-notes">Notes (Optional)</label>
                        <textarea id="borrow-lent-notes" rows="3" placeholder="e.g., For lunch"></textarea>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="borrow-lent-paid">
                        <label for="borrow-lent-paid">Mark as Paid/Returned</label>
                    </div>
                    <button type="submit" class="primary-btn" id="save-borrow-lent-btn">Save Record</button>
                    <button type="button" class="secondary-btn back-to-borrow-lent-btn">Cancel</button>
                </form>
            </section>

            <section id="budget-view" class="view">
                <h2 class="section-title">Monthly Budget</h2>
                <div class="budget-controls">
                    <button id="prev-month-btn" class="icon-btn"><i class="fas fa-chevron-left"></i></button>
                    <span id="current-budget-month" class="month-display">July 2025</span>
                    <button id="next-month-btn" class="icon-btn"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="form-group budget-goal-input-group">
                    <label for="monthly-budget-goal">Set Monthly Budget Goal (₹)</label>
                    <input type="number" id="monthly-budget-goal" placeholder="e.g., 10000" step="0.01">
                    <button id="save-budget-goal-btn" class="primary-btn small-btn">Save</button>
                </div>

                <div class="budget-summary-card">
                    <div class="summary-item">
                        <p class="summary-label">Budget Goal</p>
                        <p class="summary-value budget-goal">₹ <span id="display-budget-goal">0.00</span></p>
                    </div>
                    <div class="summary-item">
                        <p class="summary-label">Total Expenses</p>
                        <p class="summary-value total-expenses">₹ <span id="display-total-expenses">0.00</span></p>
                    </div>
                    <div class="summary-item">
                        <p class="summary-label">Remaining Budget</p>
                        <p class="summary-value remaining-budget">₹ <span id="display-remaining-budget" class="positive">0.00</span></p>
                    </div>
                </div>

                <div class="budget-progress-bar-container">
                    <div class="budget-progress-bar" id="budget-progress-bar"></div>
                </div>
                <p class="progress-label" id="budget-progress-label">0% of budget used</p>

                <h3 class="subsection-title">Expenses by Category for this Month</h3>
                <ul id="budget-category-expenses-list" class="category-summary-list">
                    <li class="no-categories">No expenses for this month.</li>
                </ul>

                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

            <section id="backup-view" class="view">
                <h2 class="section-title">Data Backup & Restore</h2>
                <div class="backup-restore-actions">
                    <button class="primary-btn" id="backup-data-btn">
                        <i class="fas fa-download"></i>
                        <span>Backup Data</span>
                    </button>
                    <button class="secondary-btn" id="restore-data-btn">
                        <i class="fas fa-upload"></i>
                        <span>Restore Data</span>
                    </button>
                </div>
                 <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>


        </main>

        <div id="calculator" class="calculator-container" style="display: none;">
            <div class="calculator-display">
                <input type="text" id="calc-output" readonly value="0">
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn clear" data-action="clear">C</button>
                <button class="calc-btn operator" data-action="divide">/</button>
                <button class="calc-btn operator" data-action="multiply">*</button>
                <button class="calc-btn backspace" data-action="backspace"><i class="fas fa-backspace"></i></button>

                <button class="calc-btn number">7</button>
                <button class="calc-btn number">8</button>
                <button class="calc-btn number">9</button>
                <button class="calc-btn operator" data-action="subtract">-</button>

                <button class="calc-btn number">4</button>
                <button class="calc-btn number">5</button>
                <button class="calc-btn number">6</button>
                <button class="calc-btn operator" data-action="add">+</button>

                <button class="calc-btn number">1</button>
                <button class="calc-btn number">2</button>
                <button class="calc-btn number">3</button>
                <button class="calc-btn equals" data-action="equals">=</button>

                <button class="calc-btn number zero">0</button>
                <button class="calc-btn number decimal">.</button>
                <button class="calc-btn apply-calc" data-action="apply">Apply</button>
            </div>
        </div>

        <nav class="bottom-nav">
            <button class="nav-item active" data-view="dashboard-view">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-item" data-view="add-expense-view">
                <i class="fas fa-plus-circle"></i>
                <span>Add</span>
            </button>
            <button class="nav-item" data-view="categories-view">
                <i class="fas fa-tags"></i>
                <span>Categories</span>
            </button>
            <button class="nav-item" data-view="filtered-transactions-view">
                <i class="fas fa-filter"></i>
                <span>Filter</span>
            </button>
            <button class="nav-item" data-view="borrowed-lent-view">
                <i class="fas fa-hand-holding-dollar"></i>
                <span>Debts</span>
            </button>
            <button class="nav-item" data-view="budget-view">
                <i class="fas fa-chart-pie"></i>
                <span>Budget</span>
            </button>
            <button class="nav-item" data-view="backup-view"> <i class="fas fa-database"></i>
                <span>Backup</span>
            </button>
        </nav>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const appContainer = document.querySelector('.app-container');
            const mainContent = document.querySelector('.main-content');
            const navItems = document.querySelectorAll('.bottom-nav .nav-item');
            const views = document.querySelectorAll('.view');
            const backToDashboardBtns = document.querySelectorAll('.back-to-dashboard-btn');
            const quickActionBtns = document.querySelectorAll('.quick-actions .action-btn'); // Only "Add New" remains

            // Dashboard elements
            const balanceAmountSpan = document.querySelector('.balance-amount span');
            const recentTransactionList = document.getElementById('recent-transaction-list');
            const noRecentTransactionsMessage = recentTransactionList.querySelector('.no-transactions');

            // Add Transaction elements (formerly Add Expense)
            const transactionForm = document.getElementById('expense-form'); // Retain ID for now
            const transactionIdInput = document.getElementById('expense-id'); // For future edit functionality
            const transactionTypeRadios = document.querySelectorAll('input[name="transaction-type"]');
            const transactionAmountInput = document.getElementById('expense-amount');
            const transactionDescriptionInput = document.getElementById('expense-description');
            const transactionDateInput = document.getElementById('expense-date');
            const transactionCategorySelect = document.getElementById('expense-category');
            const saveTransactionBtn = document.getElementById('save-expense-btn'); // Retain ID for now

            // Categories elements
            const categoryListUl = document.getElementById('category-list');
            const newCategoryInput = document.getElementById('new-category-name');
            const addNewCategoryBtn = document.getElementById('add-new-category-btn');

            // Filtered Transactions elements
            const filteredTransactionList = document.getElementById('filtered-transaction-list');
            const noFilteredTransactionsMessage = filteredTransactionList.querySelector('.no-transactions');
            const filterStartDateInput = document.getElementById('filter-start-date');
            const filterEndDateInput = document.getElementById('filter-end-date');
            const filterCategorySelect = document.getElementById('filter-category');
            const filterTypeSelect = document.getElementById('filter-type');
            const applyFilterBtn = document.getElementById('apply-filter-btn');
            const clearFilterBtn = document.getElementById('clear-filter-btn');

            // Borrowed/Lent elements
            const totalLentSpan = document.getElementById('total-lent');
            const totalBorrowedSpan = document.getElementById('total-borrowed');
            const addBorrowLentBtn = document.getElementById('add-borrow-lent-btn');
            const borrowedLentListUl = document.getElementById('borrowed-lent-list');
            const noBorrowedLentRecordsMessage = borrowedLentListUl.querySelector('.no-records');

            // Add/Edit Borrowed/Lent Form elements
            const borrowLentForm = document.getElementById('borrow-lent-form');
            const borrowLentIdInput = document.getElementById('borrow-lent-id');
            const borrowLentTypeRadios = document.querySelectorAll('input[name="borrow-lent-type"]');
            const borrowLentAmountInput = document.getElementById('borrow-lent-amount');
            const borrowLentPersonInput = document.getElementById('borrow-lent-person');
            const borrowLentDateInput = document.getElementById('borrow-lent-date');
            const borrowLentNotesInput = document.getElementById('borrow-lent-notes');
            const borrowLentPaidCheckbox = document.getElementById('borrow-lent-paid');
            const saveBorrowLentBtn = document.getElementById('save-borrow-lent-btn');
            const backToBorrowLentBtn = document.querySelector('#add-borrow-lent-view .back-to-borrow-lent-btn'); // Specific back button for borrow/lent form


            // Budget Section Elements
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const currentBudgetMonthDisplay = document.getElementById('current-budget-month');
            const monthlyBudgetGoalInput = document.getElementById('monthly-budget-goal');
            const saveBudgetGoalBtn = document.getElementById('save-budget-goal-btn');
            const displayBudgetGoal = document.getElementById('display-budget-goal');
            const displayTotalExpenses = document.getElementById('display-total-expenses');
            const displayRemainingBudget = document.getElementById('display-remaining-budget');
            const budgetProgressBar = document.getElementById('budget-progress-bar');
            const budgetProgressLabel = document.getElementById('budget-progress-label');
            const budgetCategoryExpensesList = document.getElementById('budget-category-expenses-list');
            const noBudgetCategoryExpensesMessage = budgetCategoryExpensesList.querySelector('.no-categories');

            // Theme toggle
            const themeToggleBtn = document.getElementById('themeToggle');

            // Calculator Elements
            const calculatorToggleBtn = document.getElementById('calculatorToggle');
            const calculatorContainer = document.getElementById('calculator');
            const calcOutput = document.getElementById('calc-output');
            const calcButtons = calculatorContainer.querySelector('.calculator-buttons');
            let currentInput = '0';
            let firstOperand = null;
            let operator = null;
            let waitingForSecondOperand = false;

            // Backup/Restore buttons (moved to #backup-view)
            const backupDataBtn = document.getElementById('backup-data-btn');
            const restoreDataBtn = document.getElementById('restore-data-btn');

            // --- Data Storage (Using localStorage) ---
            let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            let categories = JSON.parse(localStorage.getItem('categories')) || ['Food', 'Transport', 'Study', 'Entertainment', 'Rent', 'Utilities', 'Shopping', 'Others'];
            let borrowedLentRecords = JSON.parse(localStorage.getItem('borrowedLentRecords')) || [];
            let currentTheme = localStorage.getItem('theme') || 'light';
            let monthlyBudgets = JSON.parse(localStorage.getItem('monthlyBudgets')) || {};
            let currentBudgetMonth = new Date(); // Tracks the month currently displayed in the budget section

            // --- Global Filtering State for the Filtered Transactions Section ---
            let currentFilter = { startDate: null, endDate: null, category: 'all', type: 'all' };

            // --- Utility Functions ---
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }

            function saveData() {
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('borrowedLentRecords', JSON.stringify(borrowedLentRecords));
                localStorage.setItem('monthlyBudgets', JSON.stringify(monthlyBudgets));
            }

            function formatDate(dateString) {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            }

            function formatCurrency(amount) {
                return parseFloat(amount).toFixed(2);
            }

            // --- Initial Setup Functions ---
            function initializeApp() {
                applyTheme(currentTheme);
                populateCategorySelects();
                updateBalance();
                displayRecentTransactions();
                transactionDateInput.valueAsDate = new Date();
                setDefaultFilterDates();
                updateBorrowedLentSummary();
                displayBorrowedLentRecords();
                borrowLentDateInput.valueAsDate = new Date();
                calculatorContainer.style.display = 'none';
                resetCalculator();
                initializeBudgetSection();
            }

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                    themeToggleBtn.classList.remove('fa-sun');
                    themeToggleBtn.classList.add('fa-moon');
                } else {
                    document.body.classList.remove('dark-theme');
                    themeToggleBtn.classList.remove('fa-moon');
                    themeToggleBtn.classList.add('fa-sun');
                }
                currentTheme = theme;
                localStorage.setItem('theme', theme);
            }

            function switchView(viewId) {
                views.forEach(view => {
                    view.classList.remove('active');
                });
                document.getElementById(viewId).classList.add('active');
                navItems.forEach(item => {
                    if (item.dataset.view === viewId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                // Specific actions on view switch
                if (viewId === 'dashboard-view') {
                    updateBalance();
                    displayRecentTransactions();
                } else if (viewId === 'categories-view') {
                    displayCategoriesList();
                    populateCategorySelects();
                } else if (viewId === 'add-expense-view') {
                    resetTransactionForm();
                    populateCategorySelects();
                } else if (viewId === 'filtered-transactions-view') {
                    populateCategorySelects();
                    displayFilteredTransactions();
                } else if (viewId === 'borrowed-lent-view') {
                    updateBorrowedLentSummary();
                    displayBorrowedLentRecords();
                } else if (viewId === 'add-borrow-lent-view') {
                    resetBorrowLentForm();
                } else if (viewId === 'budget-view') {
                    updateBudgetDisplay();
                }
            }

            // --- Dashboard Functionality ---
            function updateBalance() {
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const currentBalance = totalIncome - totalExpenses;
                balanceAmountSpan.textContent = formatCurrency(currentBalance);
            }

            function displayRecentTransactions() {
                recentTransactionList.innerHTML = '';
                if (transactions.length === 0) {
                    recentTransactionList.appendChild(noRecentTransactionsMessage);
                    noRecentTransactionsMessage.style.display = 'block';
                    return;
                }
                noRecentTransactionsMessage.style.display = 'none';

                const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                const recentFive = sortedTransactions.slice(0, 5);

                recentFive.forEach(t => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('transaction-item', t.type);
                    listItem.innerHTML = `
                        <div class="transaction-icon">
                            <i class="${t.type === 'expense' ? 'fas fa-minus-circle' : 'fas fa-plus-circle'}"></i>
                        </div>
                        <div class="transaction-info">
                            <p class="transaction-description">${t.description}</p>
                            <p class="transaction-date">${formatDate(t.date)}</p>
                            <p class="transaction-category">${t.category}</p>
                        </div>
                        <div class="transaction-amount">₹ ${formatCurrency(t.amount)}</div>
                        <div class="transaction-actions">
                            <button class="edit-btn" data-id="${t.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" data-id="${t.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    recentTransactionList.appendChild(listItem);
                });

                recentTransactionList.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => editTransaction(e.currentTarget.dataset.id));
                });
                recentTransactionList.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => deleteTransaction(e.currentTarget.dataset.id));
                });
            }

            // --- Add/Edit Transaction Functionality ---
            function populateCategorySelects() {
                const categorySelects = [transactionCategorySelect, filterCategorySelect];
                categorySelects.forEach(select => {
                    // Store the currently selected value to restore it later if editing
                    const selectedValue = select.value;
                    select.innerHTML = '<option value="">Select a category</option>';
                    if (select.id === 'filter-category') {
                        select.innerHTML = '<option value="all">All Categories</option>';
                    }
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        select.appendChild(option);
                    });
                    // Restore the selected value
                    if (selectedValue && (select.querySelector(`option[value="${selectedValue}"]`) || select.id === 'filter-category' && selectedValue === 'all')) {
                        select.value = selectedValue;
                    }
                });
            }

            function resetTransactionForm() {
                transactionIdInput.value = '';
                transactionTypeRadios[0].checked = true; // Default to expense
                transactionAmountInput.value = '';
                transactionDescriptionInput.value = '';
                transactionDateInput.valueAsDate = new Date(); // Set to current date
                transactionCategorySelect.value = '';
                saveTransactionBtn.textContent = 'Add Transaction';
            }

            transactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addOrUpdateTransaction();
            });

            function addOrUpdateTransaction() {
                const id = transactionIdInput.value || generateId();
                const type = document.querySelector('input[name="transaction-type"]:checked').value;
                const amount = parseFloat(transactionAmountInput.value);
                const description = transactionDescriptionInput.value.trim();
                const date = transactionDateInput.value;
                const category = transactionCategorySelect.value;

                if (!amount || amount <= 0 || !description || !date || !category) {
                    alert('Please fill in all transaction fields correctly (Amount must be positive).');
                    return;
                }

                const newTransaction = { id, type, amount, description, date, category };

                const existingIndex = transactions.findIndex(t => t.id === id);
                if (existingIndex > -1) {
                    transactions[existingIndex] = newTransaction; // Update existing
                } else {
                    transactions.push(newTransaction); // Add new
                }

                saveData();
                updateBalance();
                displayRecentTransactions();
                resetTransactionForm();
                switchView('dashboard-view');
                alert('Transaction saved successfully!');
            }

            function editTransaction(id) {
                const transaction = transactions.find(t => t.id === id);
                if (!transaction) return;

                transactionIdInput.value = transaction.id;
                document.querySelector(`input[name="transaction-type"][value="${transaction.type}"]`).checked = true;
                transactionAmountInput.value = transaction.amount;
                transactionDescriptionInput.value = transaction.description;
                transactionDateInput.value = transaction.date;
                transactionCategorySelect.value = transaction.category;
                saveTransactionBtn.textContent = 'Update Transaction';
                switchView('add-expense-view');
            }

            function deleteTransaction(id) {
                if (confirm('Are you sure you want to delete this transaction?')) {
                    transactions = transactions.filter(t => t.id !== id);
                    saveData();
                    updateBalance();
                    displayRecentTransactions();
                    displayFilteredTransactions(); // Also update filtered list if it's open
                    updateBudgetDisplay(); // Update budget view
                    alert('Transaction deleted.');
                }
            }


            // --- Categories Management ---
            function displayCategoriesList() {
                categoryListUl.innerHTML = '';
                if (categories.length === 0) {
                    categoryListUl.innerHTML = '<li class="no-transactions">No custom categories added.</li>'; // Reusing no-transactions class for styling
                    return;
                }

                categories.forEach(category => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('category-item');
                    listItem.innerHTML = `
                        <span>${category}</span>
                        <div class="action-buttons">
                            <button class="delete-category-btn" data-category="${category}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    categoryListUl.appendChild(listItem);
                });

                categoryListUl.querySelectorAll('.delete-category-btn').forEach(button => {
                    button.addEventListener('click', (e) => deleteCategory(e.currentTarget.dataset.category));
                });
            }

            addNewCategoryBtn.addEventListener('click', addCategory);

            function addCategory() {
                const newCategoryName = newCategoryInput.value.trim();
                if (newCategoryName && !categories.includes(newCategoryName)) {
                    categories.push(newCategoryName);
                    saveData();
                    newCategoryInput.value = '';
                    displayCategoriesList();
                    populateCategorySelects(); // Update all category dropdowns
                    alert('Category added!');
                } else if (categories.includes(newCategoryName)) {
                    alert('Category already exists.');
                }
            }

            function deleteCategory(categoryName) {
                // Prevent deleting default categories if needed, or implement a way to reset them.
                // For now, allow deletion, but warn if transactions use it.
                const transactionsWithCategory = transactions.filter(t => t.category === categoryName);
                if (transactionsWithCategory.length > 0) {
                    alert(`Cannot delete category "${categoryName}" because ${transactionsWithCategory.length} transactions are using it. Please reassign or delete those transactions first.`);
                    return;
                }

                if (confirm(`Are you sure you want to delete the category "${categoryName}"?`)) {
                    categories = categories.filter(c => c !== categoryName);
                    saveData();
                    displayCategoriesList();
                    populateCategorySelects();
                    alert('Category deleted.');
                }
            }

            // --- Filtered Transactions Functionality ---
            function setDefaultFilterDates() {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                filterStartDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
                filterEndDateInput.value = lastDayOfMonth.toISOString().split('T')[0];

                currentFilter.startDate = filterStartDateInput.value;
                currentFilter.endDate = filterEndDateInput.value;
                currentFilter.category = 'all';
                currentFilter.type = 'all';
            }

            applyFilterBtn.addEventListener('click', () => {
                currentFilter.startDate = filterStartDateInput.value;
                currentFilter.endDate = filterEndDateInput.value;
                currentFilter.category = filterCategorySelect.value;
                currentFilter.type = filterTypeSelect.value;
                displayFilteredTransactions();
            });

            clearFilterBtn.addEventListener('click', () => {
                setDefaultFilterDates();
                filterCategorySelect.value = 'all';
                filterTypeSelect.value = 'all';
                displayFilteredTransactions();
            });

            function displayFilteredTransactions() {
                filteredTransactionList.innerHTML = '';
                let filtered = transactions;

                if (currentFilter.startDate) {
                    filtered = filtered.filter(t => new Date(t.date) >= new Date(currentFilter.startDate));
                }
                if (currentFilter.endDate) {
                    filtered = filtered.filter(t => new Date(t.date) <= new Date(currentFilter.endDate));
                }
                if (currentFilter.category !== 'all') {
                    filtered = filtered.filter(t => t.category === currentFilter.category);
                }
                if (currentFilter.type !== 'all') {
                    filtered = filtered.filter(t => t.type === currentFilter.type);
                }

                if (filtered.length === 0) {
                    filteredTransactionList.appendChild(noFilteredTransactionsMessage);
                    noFilteredTransactionsMessage.style.display = 'block';
                    return;
                }
                noFilteredTransactionsMessage.style.display = 'none';


                const sortedFiltered = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedFiltered.forEach(t => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('transaction-item', t.type);
                    listItem.innerHTML = `
                        <div class="transaction-icon">
                            <i class="${t.type === 'expense' ? 'fas fa-minus-circle' : 'fas fa-plus-circle'}"></i>
                        </div>
                        <div class="transaction-info">
                            <p class="transaction-description">${t.description}</p>
                            <p class="transaction-date">${formatDate(t.date)}</p>
                            <p class="transaction-category">${t.category}</p>
                        </div>
                        <div class="transaction-amount">₹ ${formatCurrency(t.amount)}</div>
                        <div class="transaction-actions">
                            <button class="edit-btn" data-id="${t.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" data-id="${t.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    filteredTransactionList.appendChild(listItem);
                });

                filteredTransactionList.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => editTransaction(e.currentTarget.dataset.id));
                });
                filteredTransactionList.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => deleteTransaction(e.currentTarget.dataset.id));
                });
            }

            // --- Borrowed/Lent Functionality ---
            function updateBorrowedLentSummary() {
                const totalLent = borrowedLentRecords.filter(r => r.type === 'lent' && !r.paid).reduce((sum, r) => sum + parseFloat(r.amount), 0);
                const totalBorrowed = borrowedLentRecords.filter(r => r.type === 'borrowed' && !r.paid).reduce((sum, r) => sum + parseFloat(r.amount), 0);
                totalLentSpan.textContent = formatCurrency(totalLent);
                totalBorrowedSpan.textContent = formatCurrency(totalBorrowed);
            }

            function displayBorrowedLentRecords() {
                borrowedLentListUl.innerHTML = '';
                if (borrowedLentRecords.length === 0) {
                    borrowedLentListUl.appendChild(noBorrowedLentRecordsMessage);
                    noBorrowedLentRecordsMessage.style.display = 'block';
                    return;
                }
                noBorrowedLentRecordsMessage.style.display = 'none';

                const sortedRecords = [...borrowedLentRecords].sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedRecords.forEach(record => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('borrowed-lent-item', record.type, record.paid ? 'paid' : '');
                    listItem.innerHTML = `
                        <div class="borrowed-lent-info">
                            <p class="borrowed-lent-description">${record.description} with <span class="person-name">${record.person}</span></p>
                            <p class="borrowed-lent-date">${formatDate(record.date)}</p>
                            ${record.notes ? `<p class="borrowed-lent-notes">Notes: ${record.notes}</p>` : ''}
                        </div>
                        <div class="borrowed-lent-amount">
                            ₹ ${formatCurrency(record.amount)}
                        </div>
                        <div class="borrowed-lent-actions">
                            <button class="toggle-paid-btn" data-id="${record.id}" title="${record.paid ? 'Mark as Unpaid' : 'Mark as Paid'}">
                                <i class="${record.paid ? 'fas fa-check-circle' : 'far fa-circle'}"></i>
                            </button>
                            <button class="edit-borrow-lent-btn" data-id="${record.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-borrow-lent-btn" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    borrowedLentListUl.appendChild(listItem);
                });

                borrowedLentListUl.querySelectorAll('.edit-borrow-lent-btn').forEach(button => {
                    button.addEventListener('click', (e) => editBorrowLentRecord(e.currentTarget.dataset.id));
                });
                borrowedLentListUl.querySelectorAll('.delete-borrow-lent-btn').forEach(button => {
                    button.addEventListener('click', (e) => deleteBorrowLentRecord(e.currentTarget.dataset.id));
                });
                 borrowedLentListUl.querySelectorAll('.toggle-paid-btn').forEach(button => {
                    button.addEventListener('click', (e) => toggleBorrowLentPaidStatus(e.currentTarget.dataset.id));
                });
            }

            addBorrowLentBtn.addEventListener('click', () => switchView('add-borrow-lent-view'));

            function resetBorrowLentForm() {
                borrowLentIdInput.value = '';
                borrowLentTypeRadios[0].checked = true; // Default to lent
                borrowLentAmountInput.value = '';
                borrowLentPersonInput.value = '';
                borrowLentDateInput.valueAsDate = new Date();
                borrowLentNotesInput.value = '';
                borrowLentPaidCheckbox.checked = false;
                saveBorrowLentBtn.textContent = 'Save Record';
            }

            borrowLentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addOrUpdateBorrowLentRecord();
            });

            function addOrUpdateBorrowLentRecord() {
                const id = borrowLentIdInput.value || generateId();
                const type = document.querySelector('input[name="borrow-lent-type"]:checked').value;
                const amount = parseFloat(borrowLentAmountInput.value);
                const person = borrowLentPersonInput.value.trim();
                const date = borrowLentDateInput.value;
                const notes = borrowLentNotesInput.value.trim();
                const paid = borrowLentPaidCheckbox.checked;
                const description = `${type === 'lent' ? 'Lent' : 'Borrowed'} ₹${formatCurrency(amount)}`; // Simple description

                if (!amount || amount <= 0 || !person || !date) {
                    alert('Please fill in all required fields (Amount, Person, Date).');
                    return;
                }

                const newRecord = { id, type, amount, person, date, notes, paid, description };

                const existingIndex = borrowedLentRecords.findIndex(r => r.id === id);
                if (existingIndex > -1) {
                    borrowedLentRecords[existingIndex] = newRecord; // Update existing
                } else {
                    borrowedLentRecords.push(newRecord); // Add new
                }

                saveData();
                updateBorrowedLentSummary();
                displayBorrowedLentRecords();
                resetBorrowLentForm();
                switchView('borrowed-lent-view');
                alert('Borrowed/Lent record saved successfully!');
            }

            function editBorrowLentRecord(id) {
                const record = borrowedLentRecords.find(r => r.id === id);
                if (!record) return;

                borrowLentIdInput.value = record.id;
                document.querySelector(`input[name="borrow-lent-type"][value="${record.type}"]`).checked = true;
                borrowLentAmountInput.value = record.amount;
                borrowLentPersonInput.value = record.person;
                borrowLentDateInput.value = record.date;
                borrowLentNotesInput.value = record.notes;
                borrowLentPaidCheckbox.checked = record.paid;
                saveBorrowLentBtn.textContent = 'Update Record';
                switchView('add-borrow-lent-view');
            }

            function deleteBorrowLentRecord(id) {
                if (confirm('Are you sure you want to delete this record?')) {
                    borrowedLentRecords = borrowedLentRecords.filter(r => r.id !== id);
                    saveData();
                    updateBorrowedLentSummary();
                    displayBorrowedLentRecords();
                    alert('Record deleted.');
                }
            }

            function toggleBorrowLentPaidStatus(id) {
                const record = borrowedLentRecords.find(r => r.id === id);
                if (record) {
                    record.paid = !record.paid;
                    saveData();
                    updateBorrowedLentSummary();
                    displayBorrowedLentRecords();
                    alert(`Record marked as ${record.paid ? 'Paid/Returned' : 'Unpaid/Unreturned'}.`);
                }
            }


            // --- Budget Functionality ---
            function getMonthKey(date) {
                return date.getFullYear() + '-' + (date.getMonth() + 1).toString().padStart(2, '0');
            }

            function initializeBudgetSection() {
                currentBudgetMonth = new Date(); // Set to current month on init
                updateBudgetDisplay();
            }

            function updateBudgetDisplay() {
                const monthKey = getMonthKey(currentBudgetMonth);
                currentBudgetMonthDisplay.textContent = currentBudgetMonth.toLocaleString('en-US', { month: 'long', year: 'numeric' });

                const budgetGoal = monthlyBudgets[monthKey] || 0;
                monthlyBudgetGoalInput.value = budgetGoal > 0 ? budgetGoal : '';
                displayBudgetGoal.textContent = formatCurrency(budgetGoal);

                const currentMonthExpenses = transactions.filter(t =>
                    t.type === 'expense' && getMonthKey(new Date(t.date)) === monthKey
                ).reduce((sum, t) => sum + parseFloat(t.amount), 0);
                displayTotalExpenses.textContent = formatCurrency(currentMonthExpenses);

                const remainingBudget = budgetGoal - currentMonthExpenses;
                displayRemainingBudget.textContent = formatCurrency(remainingBudget);
                displayRemainingBudget.classList.toggle('negative', remainingBudget < 0);
                displayRemainingBudget.classList.toggle('positive', remainingBudget >= 0);


                // Update progress bar
                let percentage = 0;
                if (budgetGoal > 0) {
                    percentage = (currentMonthExpenses / budgetGoal) * 100;
                    if (percentage > 100) percentage = 100; // Cap at 100% for visual
                }
                budgetProgressBar.style.width = percentage + '%';
                budgetProgressBar.style.backgroundColor = percentage > 80 ? 'var(--expense-color)' : 'var(--accent-color)'; // Red if over 80%

                budgetProgressLabel.textContent = `${percentage.toFixed(1)}% of budget used`;
                if (remainingBudget < 0) {
                    budgetProgressLabel.textContent += ` (₹${formatCurrency(Math.abs(remainingBudget))} over budget)`;
                    budgetProgressLabel.style.color = 'var(--expense-color)';
                } else {
                    budgetProgressLabel.style.color = 'var(--text-color)';
                }

                displayBudgetCategoryExpenses(monthKey);
            }

            saveBudgetGoalBtn.addEventListener('click', saveMonthlyBudgetGoal);
            function saveMonthlyBudgetGoal() {
                const monthKey = getMonthKey(currentBudgetMonth);
                const newGoal = parseFloat(monthlyBudgetGoalInput.value);

                if (!isNaN(newGoal) && newGoal >= 0) {
                    monthlyBudgets[monthKey] = newGoal;
                    saveData();
                    updateBudgetDisplay();
                    alert('Budget goal saved!');
                } else {
                    alert('Please enter a valid positive number for the budget goal.');
                }
            }

            prevMonthBtn.addEventListener('click', () => {
                currentBudgetMonth.setMonth(currentBudgetMonth.getMonth() - 1);
                updateBudgetDisplay();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentBudgetMonth.setMonth(currentBudgetMonth.getMonth() + 1);
                updateBudgetDisplay();
            });

            function displayBudgetCategoryExpenses(monthKey) {
                budgetCategoryExpensesList.innerHTML = '';
                const expensesForMonth = transactions.filter(t =>
                    t.type === 'expense' && getMonthKey(new Date(t.date)) === monthKey
                );

                if (expensesForMonth.length === 0) {
                    budgetCategoryExpensesList.appendChild(noBudgetCategoryExpensesMessage);
                    noBudgetCategoryExpensesMessage.style.display = 'block';
                    return;
                }
                noBudgetCategoryExpensesMessage.style.display = 'none';

                const categorySums = expensesForMonth.reduce((acc, transaction) => {
                    acc[transaction.category] = (acc[transaction.category] || 0) + parseFloat(transaction.amount);
                    return acc;
                }, {});

                // Sort categories by amount spent (descending)
                const sortedCategories = Object.entries(categorySums).sort(([, amountA], [, amountB]) => amountB - amountA);

                sortedCategories.forEach(([categoryName, totalAmount]) => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('category-summary-item');
                    listItem.innerHTML = `
                        <span class="category-summary-name">${categoryName}</span>
                        <span class="category-summary-amount">₹ ${formatCurrency(totalAmount)}</span>
                    `;
                    budgetCategoryExpensesList.appendChild(listItem);
                });
            }


            // --- Calculator Functionality ---
            function calculate(first, second, operator) {
                first = parseFloat(first);
                second = parseFloat(second);
                if (isNaN(first) || isNaN(second)) return NaN; // Handle invalid input

                switch (operator) {
                    case '+': return first + second;
                    case '-': return first - second;
                    case '*': return first * second;
                    case '/': return second === 0 ? NaN : first / second; // Prevent division by zero
                    default: return NaN;
                }
            }

            function updateDisplay() {
                calcOutput.value = currentInput;
            }

            function resetCalculator() {
                currentInput = '0';
                firstOperand = null;
                operator = null;
                waitingForSecondOperand = false;
                updateDisplay();
            }

            calcButtons.addEventListener('click', (event) => {
                const { target } = event;
                if (!target.matches('button')) return;

                const action = target.dataset.action; // Get data-action for operators and special buttons

                if (target.classList.contains('number')) {
                    if (waitingForSecondOperand) {
                        currentInput = target.textContent;
                        waitingForSecondOperand = false;
                    } else {
                        currentInput = currentInput === '0' ? target.textContent : currentInput + target.textContent;
                    }
                } else if (target.classList.contains('decimal')) {
                    if (!currentInput.includes('.')) {
                        currentInput += '.';
                    }
                } else if (target.classList.contains('operator')) {
                    const nextOperator = action;
                    if (firstOperand === null) {
                        firstOperand = parseFloat(currentInput);
                    } else if (operator) {
                        const result = calculate(firstOperand, parseFloat(currentInput), operator);
                        currentInput = parseFloat(result.toFixed(5)).toString(); // Limit decimal places for display
                        firstOperand = parseFloat(currentInput);
                    }
                    waitingForSecondOperand = true;
                    operator = nextOperator === 'add' ? '+' : nextOperator === 'subtract' ? '-' : nextOperator === 'multiply' ? '*' : '/';
                } else if (action === 'equals') {
                    if (firstOperand !== null && operator !== null) {
                        const result = calculate(firstOperand, parseFloat(currentInput), operator);
                        currentInput = parseFloat(result.toFixed(5)).toString();
                        firstOperand = null;
                        operator = null;
                        waitingForSecondOperand = true;
                    }
                } else if (action === 'clear') {
                    resetCalculator();
                } else if (action === 'backspace') {
                    currentInput = currentInput.slice(0, -1) || '0';
                } else if (action === 'apply') {
                    // Apply logic to specific active input field
                    if (document.getElementById('add-expense-view').classList.contains('active')) {
                        transactionAmountInput.value = parseFloat(calcOutput.value);
                    } else if (document.getElementById('add-borrow-lent-view').classList.contains('active')) {
                        borrowLentAmountInput.value = parseFloat(calcOutput.value);
                    } else {
                        alert("Calculator result can only be applied to the 'Amount' field when adding/editing a transaction or borrowed/lent record.");
                    }
                    calculatorContainer.style.display = 'none'; // Hide calculator after applying
                    resetCalculator(); // Reset calculator for next use
                }
                updateDisplay();
            });

            // --- Backup and Restore Functionality (Now in #backup-view) ---
            backupDataBtn.addEventListener('click', () => {
                const data = {
                    transactions: transactions,
                    categories: categories,
                    borrowedLentRecords: borrowedLentRecords,
                    monthlyBudgets: monthlyBudgets
                };
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'expense_tracker_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('Data backed up successfully as expense_tracker_data.json!');
            });

            restoreDataBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            try {
                                const loadedData = JSON.parse(event.target.result);
                                if (confirm('Restoring data will overwrite your current data. Are you sure?')) {
                                    transactions = loadedData.transactions || [];
                                    categories = loadedData.categories || ['Food', 'Transport', 'Study', 'Entertainment', 'Rent', 'Utilities', 'Shopping', 'Others'];
                                    borrowedLentRecords = loadedData.borrowedLentRecords || [];
                                    monthlyBudgets = loadedData.monthlyBudgets || {};
                                    saveData();
                                    initializeApp(); // Reinitialize UI with new data
                                    alert('Data restored successfully!');
                                    switchView('dashboard-view');
                                }
                            } catch (error) {
                                alert('Failed to restore data. Please ensure the file is a valid JSON export.');
                                console.error('Error restoring data:', error);
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            });


            // --- Event Listeners ---
            themeToggleBtn.addEventListener('click', () => {
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                applyTheme(newTheme);
            });

            calculatorToggleBtn.addEventListener('click', () => {
                calculatorContainer.style.display = calculatorContainer.style.display === 'none' ? 'flex' : 'none';
                if (calculatorContainer.style.display === 'none') {
                    resetCalculator(); // Reset when hiding
                }
            });

            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    switchView(item.dataset.view);
                });
            });

            backToDashboardBtns.forEach(btn => {
                btn.addEventListener('click', () => switchView('dashboard-view'));
            });

            // Specific back button for add-borrow-lent-view
            backToBorrowLentBtn.addEventListener('click', () => switchView('borrowed-lent-view'));


            // Quick Actions buttons (only "Add New" remains relevant)
            quickActionBtns.forEach(btn => {
                if (btn.dataset.view) {
                    btn.addEventListener('click', () => switchView(btn.dataset.view));
                }
            });

            // --- Initialize on Load ---
            initializeApp();
        });
    </script>
</body>
</html>
