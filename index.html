<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Expense Tracker</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <i class="fas fa-sun toggle-theme-btn" id="themeToggle"></i> </div>
            <div class="header-center">
                <h1 class="app-title">Expense Tracker</h1>
            </div>
            <div class="header-right">
                <i class="fas fa-calculator toggle-calculator-btn" id="calculatorToggle"></i> </div>
        </header>

        <main class="main-content">
            <section id="dashboard-view" class="view active">
                <div class="monthly-expense-card">
                    <p class="monthly-expense-label">Monthly Expenses</p>
                    <p class="monthly-expense-amount">₹ <span id="display-monthly-expenses">0.00</span></p>
                </div>

                <div class="overall-summary-card">
                    <p class="overall-label">Overall Total Transactions</p>
                    <p class="overall-amount">₹ <span id="overall-total-amount">0.00</span></p>
                </div>

                <h2 class="section-title">Recent Transactions</h2>
                <ul class="transaction-list" id="recent-transaction-list">
                    <li class="no-transactions">No transactions yet! Add one to get started.</li>
                </ul>
            </section>

            <section id="add-expense-view" class="view">
                <h2 class="section-title">Add New Transaction</h2>
                <form id="expense-form" class="expense-form">
                    <input type="hidden" id="expense-id"> <div class="form-group">
                        <label for="transaction-type">Transaction Type</label>
                        <div class="transaction-type-selector">
                            <input type="radio" id="type-expense" name="transaction-type" value="expense" checked>
                            <label for="type-expense">Expense</label>
                            <input type="radio" id="type-income" name="transaction-type" value="income">
                            <label for="type-income">Income</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="expense-amount">Amount</label>
                        <input type="number" id="expense-amount" placeholder="e.g., 500" required step="0.01">
                        </div>
                    <div class="form-group">
                        <label for="expense-description">Description</label>
                        <input type="text" id="expense-description" placeholder="e.g., Dinner with friends" required>
                    </div>
                     <div class="form-group">
                        <label for="expense-date">Date</label>
                        <input type="date" id="expense-date" value="" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-category">Category</label>
                        <select id="expense-category" required>
                            <option value="">Select a category</option>
                        </select>
                    </div>
                    <button type="submit" class="primary-btn" id="save-expense-btn">Add Transaction</button>
                    <button type="button" class="secondary-btn back-to-dashboard-btn">Cancel</button>
                </form>

                </section>

            <section id="categories-view" class="view">
                <h2 class="section-title">Manage Categories</h2>
                <ul id="category-list" class="category-list">
                    </ul>
                <div class="add-category-section">
                    <input type="text" id="new-category-name" placeholder="New category name" class="new-category-input">
                    <button id="add-new-category-btn" class="primary-btn">Add Category</button>
                </div>
                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

             <section id="filtered-transactions-view" class="view">
                <h2 class="section-title">Filtered Transactions</h2>
                <div class="transaction-filters">
                    <input type="date" id="filter-start-date" placeholder="From Date">
                    <input type="date" id="filter-end-date" placeholder="To Date">
                    <select id="filter-category">
                        <option value="all">All Categories</option>
                        </select>
                    <select id="filter-type"> <option value="all">All Types</option>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                    <button class="secondary-btn small-btn" id="apply-filter-btn">Apply Filters</button>
                    <button class="secondary-btn small-btn" id="clear-filter-btn">Clear Filters</button>
                </div>
                <ul class="transaction-list" id="filtered-transaction-list">
                    <li class="no-transactions">Apply filters to see transactions.</li>
                </ul>
                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

            <section id="borrowed-lent-view" class="view">
                <h2 class="section-title">Borrowed/Lent Money</h2>
                <div class="summary-cards">
                    <div class="summary-card owed">
                        <h3>Money Owed to You</h3>
                        <p class="amount">₹ <span id="total-lent">0.00</span></p>
                    </div>
                    <div class="summary-card owing">
                        <h3>Money You Owe</h3>
                        <p class="amount">₹ <span id="total-borrowed">0.00</span></p>
                    </div>
                    <div class="summary-card balance-debt">
                        <h3>Current Overall Balance</h3>
                        <p class="amount">₹ <span id="display-overall-balance-in-debt">0.00</span></p>
                    </div>
                </div>

                <button class="primary-btn" id="add-borrow-lent-btn">Add Record</button>

                <h3 class="subsection-title">All Records</h3>
                <ul class="borrowed-lent-list" id="borrowed-lent-list">
                    <li class="no-records">No borrowed/lent records yet.</li>
                </ul>
                 <button type="button" class="secondary-btn back-to-borrow-lent-btn">Back to Dashboard</button>
            </section>

            <section id="add-borrow-lent-view" class="view">
                <h2 class="section-title">Add/Edit Money Record</h2>
                <form id="borrow-lent-form" class="expense-form">
                    <input type="hidden" id="borrow-lent-id">
                    <div class="form-group">
                        <label for="borrow-lent-type">Record Type</label>
                        <div class="transaction-type-selector">
                            <input type="radio" id="type-lent" name="borrow-lent-type" value="lent" checked>
                            <label for="type-lent">Money Lent</label>
                            <input type="radio" id="type-borrowed" name="borrow-lent-type" value="borrowed">
                            <label for="type-borrowed">Money Borrowed</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-amount">Amount</label>
                        <input type="number" id="borrow-lent-amount" placeholder="e.g., 200" required step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-person">Person/Party</label>
                        <input type="text" id="borrow-lent-person" placeholder="e.g., John Doe" required>
                    </div>
                     <div class="form-group">
                        <label for="borrow-lent-date">Date</label>
                        <input type="date" id="borrow-lent-date" value="" required>
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-notes">Notes (Optional)</label>
                        <textarea id="borrow-lent-notes" rows="3" placeholder="e.g., For lunch"></textarea>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="borrow-lent-paid">
                        <label for="borrow-lent-paid">Mark as Paid/Returned</label>
                    </div>
                    <button type="submit" class="primary-btn" id="save-borrow-lent-btn">Save Record</button>
                    <button type="button" class="secondary-btn back-to-borrow-lent-btn">Cancel</button>
                </form>
            </section>

            <section id="budget-view" class="view">
                <h2 class="section-title">Monthly Budget</h2>
                <div class="budget-controls">
                    <button id="prev-month-btn" class="icon-btn"><i class="fas fa-chevron-left"></i></button>
                    <span id="current-budget-month" class="month-display">July 2025</span>
                    <button id="next-month-btn" class="icon-btn"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="form-group budget-goal-input-group">
                    <label for="monthly-budget-goal">Set Monthly Budget Goal (₹)</label>
                    <input type="number" id="monthly-budget-goal" placeholder="e.g., 10000" step="0.01">
                    <button id="save-budget-goal-btn" class="primary-btn small-btn">Save</button>
                </div>

                <div class="budget-summary-card">
                    <div class="summary-item">
                        <p class="summary-label">Total Expenses</p>
                        <p class="summary-value total-expenses">₹ <span id="display-total-expenses">0.00</span></p>
                    </div>
                    <div class="summary-item">
                        <p class="summary-label">Budget Goal</p>
                        <p class="summary-value budget-goal">₹ <span id="display-budget-goal">0.00</span></p>
                    </div>
                    <div class="summary-item">
                        <p class="summary-label">Remaining Budget</p>
                        <p class="summary-value remaining-budget">₹ <span id="display-remaining-budget" class="positive">0.00</span></p>
                    </div>
                </div>

                <div class="budget-progress-bar-container">
                    <div class="budget-progress-bar" id="budget-progress-bar"></div>
                </div>
                <p class="progress-label" id="budget-progress-label">0% of budget used</p>

                <h3 class="subsection-title">Expenses by Category for this Month</h3>
                <ul id="budget-category-expenses-list" class="category-summary-list">
                    <li class="no-categories">No expenses for this month.</li>
                </ul>

                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>


        </main>

        <div id="calculator" class="calculator-container" style="display: none;">
            <div class="calculator-display">
                <input type="text" id="calc-output" readonly value="0">
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn clear" data-action="clear">C</button>
                <button class="calc-btn operator" data-action="divide">/</button>
                <button class="calc-btn operator" data-action="multiply">*</button>
                <button class="calc-btn backspace" data-action="backspace"><i class="fas fa-backspace"></i></button>

                <button class="calc-btn number">7</button>
                <button class="calc-btn number">8</button>
                <button class="calc-btn number">9</button>
                <button class="calc-btn operator" data-action="subtract">-</button>

                <button class="calc-btn number">4</button>
                <button class="calc-btn number">5</button>
                <button class="calc-btn number">6</button>
                <button class="calc-btn operator" data-action="add">+</button>

                <button class="calc-btn number">1</button>
                <button class="calc-btn number">2</button>
                <button class="calc-btn number">3</button>
                <button class="calc-btn equals" data-action="equals">=</button>

                <button class="calc-btn number zero">0</button>
                <button class="calc-btn decimal">.</button>
                <button class="calc-btn apply-calc" data-action="apply">Apply</button>
            </div>
        </div>

        <nav class="bottom-nav">
            <button class="nav-item active" data-view="dashboard-view">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-item" data-view="add-expense-view">
                <i class="fas fa-plus-circle"></i>
                <span>Add</span>
            </button>
            <button class="nav-item" data-view="categories-view">
                <i class="fas fa-tags"></i>
                <span>Categories</span>
            </button>
            <button class="nav-item" data-view="filtered-transactions-view">
                <i class="fas fa-filter"></i>
                <span>Filter</span>
            </button>
            <button class="nav-item" data-view="borrowed-lent-view">
                <i class="fas fa-hand-holding-dollar"></i> <span>Debts</span>
            </button>
            <button class="nav-item" data-view="budget-view"> <i class="fas fa-chart-pie"></i>
                <span>Budget</span>
            </button>
            </nav>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const appContainer = document.querySelector('.app-container');
            const mainContent = document.querySelector('.main-content');
            const navItems = document.querySelectorAll('.bottom-nav .nav-item');
            const views = document.querySelectorAll('.view');
            const backToDashboardBtns = document.querySelectorAll('.back-to-dashboard-btn');

            // Dashboard elements
            const displayMonthlyExpensesSpan = document.getElementById('display-monthly-expenses'); // NEW ID
            const overallTotalAmountSpan = document.getElementById('overall-total-amount');
            const recentTransactionList = document.getElementById('recent-transaction-list');
            const noRecentTransactionsMessage = recentTransactionList.querySelector('.no-transactions');

            // Add Transaction elements (formerly Add Expense)
            const transactionForm = document.getElementById('expense-form');
            const transactionIdInput = document.getElementById('expense-id');
            const transactionTypeRadios = document.querySelectorAll('input[name="transaction-type"]');
            const transactionAmountInput = document.getElementById('expense-amount');
            const transactionDescriptionInput = document.getElementById('expense-description');
            const transactionDateInput = document.getElementById('expense-date');
            const transactionCategorySelect = document.getElementById('expense-category');
            const saveTransactionBtn = document.getElementById('save-expense-btn');

            // Categories elements
            const categoryListUl = document.getElementById('category-list');
            const newCategoryInput = document.getElementById('new-category-name');
            const addNewCategoryBtn = document.getElementById('add-new-category-btn');

            // Filtered Transactions elements
            const filteredTransactionList = document.getElementById('filtered-transaction-list');
            const noFilteredTransactionsMessage = filteredTransactionList.querySelector('.no-transactions');
            const filterStartDateInput = document.getElementById('filter-start-date');
            const filterEndDateInput = document.getElementById('filter-end-date');
            const filterCategorySelect = document.getElementById('filter-category');
            const filterTypeSelect = document.getElementById('filter-type');
            const applyFilterBtn = document.getElementById('apply-filter-btn');
            const clearFilterBtn = document.getElementById('clear-filter-btn');

            // Borrowed/Lent elements (NEW SECTION)
            const totalLentSpan = document.getElementById('total-lent');
            const totalBorrowedSpan = document.getElementById('total-borrowed');
            const displayOverallBalanceInDebtSpan = document.getElementById('display-overall-balance-in-debt'); // NEW ID for balance in debt section
            const addBorrowLentBtn = document.getElementById('add-borrow-lent-btn');
            const borrowedLentListUl = document.getElementById('borrowed-lent-list');
            const noBorrowedLentRecordsMessage = borrowedLentListUl.querySelector('.no-records');

            // Add/Edit Borrowed/Lent Form elements (NEW FORM)
            const borrowLentForm = document.getElementById('borrow-lent-form');
            const borrowLentIdInput = document.getElementById('borrow-lent-id');
            const borrowLentTypeRadios = document.querySelectorAll('input[name="borrow-lent-type"]');
            const borrowLentAmountInput = document.getElementById('borrow-lent-amount');
            const borrowLentPersonInput = document.getElementById('borrow-lent-person');
            const borrowLentDateInput = document.getElementById('borrow-lent-date');
            const borrowLentNotesInput = document.getElementById('borrow-lent-notes');
            const borrowLentPaidCheckbox = document.getElementById('borrow-lent-paid');
            const saveBorrowLentBtn = document.getElementById('save-borrow-lent-btn');
            const backToBorrowLentBtn = document.querySelector('.back-to-borrow-lent-btn');

            // --- NEW: Budget Section Elements ---
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const currentBudgetMonthDisplay = document.getElementById('current-budget-month');
            const monthlyBudgetGoalInput = document.getElementById('monthly-budget-goal');
            const saveBudgetGoalBtn = document.getElementById('save-budget-goal-btn');
            const displayBudgetGoal = document.getElementById('display-budget-goal');
            const displayTotalExpenses = document.getElementById('display-total-expenses');
            const displayRemainingBudget = document.getElementById('display-remaining-budget');
            const budgetProgressBar = document.getElementById('budget-progress-bar');
            const budgetProgressLabel = document.getElementById('budget-progress-label');
            const budgetCategoryExpensesList = document.getElementById('budget-category-expenses-list');
            const noBudgetCategoryExpensesMessage = budgetCategoryExpensesList.querySelector('.no-categories');

            // Theme toggle
            const themeToggleBtn = document.getElementById('themeToggle');

            // --- Calculator Elements ---
            const calculatorToggleBtn = document.getElementById('calculatorToggle');
            const calculatorContainer = document.getElementById('calculator');
            const calcOutput = document.getElementById('calc-output');
            const calcButtons = document.querySelector('.calculator-buttons');
            let firstOperand = null;
            let operator = null;
            let waitingForSecondOperand = false;

            // --- Local Storage Keys ---
            const LS_TRANSACTIONS = 'expenseTracker.transactions';
            const LS_CATEGORIES = 'expenseTracker.categories';
            const LS_BORROWED_LENT = 'expenseTracker.borrowedLent';
            const LS_MONTHLY_BUDGET = 'expenseTracker.monthlyBudget';
            const LS_THEME = 'expenseTracker.theme';

            // --- Data Structures ---
            let transactions = [];
            let categories = new Set(['Food', 'Transport', 'Entertainment', 'Utilities', 'Rent', 'Salary', 'Freelance']);
            let borrowedLentRecords = [];
            let monthlyBudgetGoals = {};

            // --- Helper Functions ---
            function generateUniqueId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            // Function to save data to local storage
            function saveTransactions() {
                localStorage.setItem(LS_TRANSACTIONS, JSON.stringify(transactions));
            }

            function saveCategories() {
                localStorage.setItem(LS_CATEGORIES, JSON.stringify(Array.from(categories)));
            }

            function saveBorrowedLentRecords() {
                localStorage.setItem(LS_BORROWED_LENT, JSON.stringify(borrowedLentRecords));
            }

            function saveMonthlyBudgetGoals() {
                localStorage.setItem(LS_MONTHLY_BUDGET, JSON.stringify(monthlyBudgetGoals));
            }

            // Function to load data from local storage
            function loadTransactions() {
                const storedTransactions = localStorage.getItem(LS_TRANSACTIONS);
                if (storedTransactions) {
                    transactions = JSON.parse(storedTransactions);
                }
            }

            function loadCategories() {
                const storedCategories = localStorage.getItem(LS_CATEGORIES);
                if (storedCategories) {
                    categories = new Set(JSON.parse(storedCategories));
                }
            }

            function loadBorrowedLentRecords() {
                const storedRecords = localStorage.getItem(LS_BORROWED_LENT);
                if (storedRecords) {
                    borrowedLentRecords = JSON.parse(storedRecords);
                }
            }

            function loadMonthlyBudgetGoals() {
                const storedGoals = localStorage.getItem(LS_MONTHLY_BUDGET);
                if (storedGoals) {
                    monthlyBudgetGoals = JSON.parse(storedGoals);
                }
            }

            // --- UI Rendering Functions ---

            function updateDashboard() {
                renderRecentTransactions();
                updateMonthlyExpensesDisplay(); // NEW: Call function to update monthly expenses
                updateOverallTotalTransactions();
            }

            function calculateTotalBalance() {
                let balance = 0;
                transactions.forEach(t => {
                    if (t.type === 'income') {
                        balance += t.amount;
                    } else {
                        balance -= t.amount;
                    }
                });
                return balance;
            }

            function updateMonthlyExpensesDisplay() {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                let totalMonthlyExpenses = 0;
                transactions.forEach(t => {
                    const transactionDate = new Date(t.date);
                    if (t.type === 'expense' &&
                        transactionDate.getMonth() === currentMonth &&
                        transactionDate.getFullYear() === currentYear) {
                        totalMonthlyExpenses += t.amount;
                    }
                });
                displayMonthlyExpensesSpan.textContent = totalMonthlyExpenses.toFixed(2);
            }

            function renderRecentTransactions() {
                recentTransactionList.innerHTML = '';

                if (transactions.length === 0) {
                    recentTransactionList.appendChild(noRecentTransactionsMessage);
                    return;
                }

                const recentFive = transactions.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

                recentFive.forEach(transaction => {
                    const listItem = createTransactionListItem(transaction);
                    recentTransactionList.appendChild(listItem);
                });
            }

            function createTransactionListItem(transaction) {
                const listItem = document.createElement('li');
                listItem.className = `transaction-item ${transaction.type}`;
                listItem.dataset.id = transaction.id;

                const iconClass = transaction.type === 'expense' ? 'fa-minus-circle' : 'fa-plus-circle';
                const sign = transaction.type === 'expense' ? '-' : '+';

                listItem.innerHTML = `
                    <i class="fas ${iconClass} transaction-icon"></i>
                    <div class="transaction-info">
                        <p class="transaction-description">${transaction.description}</p>
                        <p class="transaction-date">${formatDate(transaction.date)}</p>
                        <p class="transaction-category">${transaction.category}</p>
                    </div>
                    <p class="transaction-amount">${sign} ₹${transaction.amount.toFixed(2)}</p>
                    <div class="transaction-actions">
                        <button class="edit-btn"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;

                listItem.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    editTransaction(transaction.id);
                });
                listItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTransaction(transaction.id);
                });

                return listItem;
            }

            function renderCategories() {
                categoryListUl.innerHTML = '';
                if (categories.size === 0) {
                    categoryListUl.innerHTML = '<li class="no-categories">No categories yet. Add one to get started.</li>';
                    return;
                }
                categories.forEach(category => {
                    const listItem = document.createElement('li');
                    listItem.className = 'category-item';
                    listItem.innerHTML = `
                        <span>${category}</span>
                        <button class="delete-category-btn" data-category="${category}"><i class="fas fa-trash-alt"></i></button>
                    `;
                    listItem.querySelector('.delete-category-btn').addEventListener('click', () => deleteCategory(category));
                    categoryListUl.appendChild(listItem);
                });
                populateCategorySelects();
            }

            function populateCategorySelects() {
                // Populate Add Transaction category select
                transactionCategorySelect.innerHTML = '<option value="">Select a category</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    transactionCategorySelect.appendChild(option);
                });

                // Populate Filter Transaction category select
                filterCategorySelect.innerHTML = '<option value="all">All Categories</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    filterCategorySelect.appendChild(option);
                });
            }

            function renderFilteredTransactions() {
                filteredTransactionList.innerHTML = '';
                const startDate = filterStartDateInput.value ? new Date(filterStartDateInput.value) : null;
                const endDate = filterEndDateInput.value ? new Date(filterEndDateInput.value) : null;
                const category = filterCategorySelect.value;
                const type = filterTypeSelect.value;

                const filtered = transactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    const matchesDate = (!startDate || transactionDate >= startDate) && (!endDate || transactionDate <= endDate);
                    const matchesCategory = (category === 'all' || t.category === category);
                    const matchesType = (type === 'all' || t.type === type);
                    return matchesDate && matchesCategory && matchesType;
                }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending

                if (filtered.length === 0) {
                    filteredTransactionList.appendChild(noFilteredTransactionsMessage);
                    return;
                }

                filtered.forEach(transaction => {
                    const listItem = createTransactionListItem(transaction);
                    filteredTransactionList.appendChild(listItem);
                });
            }

            function renderBorrowedLentRecords() {
                borrowedLentListUl.innerHTML = '';

                if (borrowedLentRecords.length === 0) {
                    borrowedLentListUl.appendChild(noBorrowedLentRecordsMessage);
                    return;
                }

                borrowedLentRecords.forEach(record => {
                    const listItem = document.createElement('li');
                    listItem.className = `borrowed-lent-item ${record.type} ${record.paid ? 'paid' : ''}`;
                    listItem.dataset.id = record.id;
                    const iconClass = record.type === 'lent' ? 'fa-hand-holding-dollar' : 'fa-money-bill-transfer'; // Icons can be refined
                    const statusText = record.paid ? '(Paid/Returned)' : '';

                    listItem.innerHTML = `
                        <i class="fas ${iconClass} record-icon"></i>
                        <div class="record-info">
                            <p class="record-person">${record.person} ${statusText}</p>
                            <p class="record-date">${formatDate(record.date)}</p>
                            <p class="record-notes">${record.notes || 'No notes'}</p>
                        </div>
                        <p class="record-amount">₹${record.amount.toFixed(2)}</p>
                        <div class="record-actions">
                            <button class="edit-btn"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;

                    listItem.querySelector('.edit-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        editBorrowedLentRecord(record.id);
                    });
                    listItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteBorrowedLentRecord(record.id);
                    });
                    borrowedLentListUl.appendChild(listItem);
                });
                updateBorrowedLentSummary();
                updateOverallBalanceInDebtSection(); // NEW: Call to update balance in debt section
            }

            function updateBorrowedLentSummary() {
                let totalLent = 0;
                let totalBorrowed = 0;
                borrowedLentRecords.forEach(record => {
                    if (!record.paid) { // Only count unpaid/unreturned
                        if (record.type === 'lent') {
                            totalLent += record.amount;
                        } else {
                            totalBorrowed += record.amount;
                        }
                    }
                });
                totalLentSpan.textContent = totalLent.toFixed(2);
                totalBorrowedSpan.textContent = totalBorrowed.toFixed(2);
            }

            function updateOverallBalanceInDebtSection() {
                const totalBalance = calculateTotalBalance(); // Re-use existing balance calculation
                displayOverallBalanceInDebtSpan.textContent = totalBalance.toFixed(2);
                // Optional: Add class for positive/negative styling if desired
                if (totalBalance < 0) {
                    displayOverallBalanceInDebtSpan.classList.remove('positive');
                    displayOverallBalanceInDebtSpan.classList.add('negative');
                } else {
                    displayOverallBalanceInDebtSpan.classList.remove('negative');
                    displayOverallBalanceInDebtSpan.classList.add('positive');
                }
            }


            // --- NEW: Budget Functions ---
            let currentBudgetDate = new Date(); // To track the month being viewed in budget

            function updateBudgetView() {
                const monthYearKey = getMonthYearKey(currentBudgetDate); // e.g., "2025-07"
                currentBudgetMonthDisplay.textContent = formatMonthYear(currentBudgetDate);

                // Set budget goal input
                const savedGoal = monthlyBudgetGoals[monthYearKey] || '';
                monthlyBudgetGoalInput.value = savedGoal;
                displayBudgetGoal.textContent = parseFloat(savedGoal || 0).toFixed(2); // Display current month's goal

                updateBudgetSummary();
                renderBudgetCategoryExpenses();
            }

            function updateBudgetSummary() {
                const monthYearKey = getMonthYearKey(currentBudgetDate);
                const budgetGoal = parseFloat(monthlyBudgetGoals[monthYearKey] || 0);
                let totalExpensesForMonth = 0;

                transactions.forEach(t => {
                    if (t.type === 'expense' && getMonthYearKey(new Date(t.date)) === monthYearKey) {
                        totalExpensesForMonth += t.amount;
                    }
                });

                displayTotalExpenses.textContent = totalExpensesForMonth.toFixed(2);
                const remainingBudget = budgetGoal - totalExpensesForMonth;
                displayRemainingBudget.textContent = remainingBudget.toFixed(2);

                // Update remaining budget color
                if (remainingBudget < 0) {
                    displayRemainingBudget.classList.remove('positive');
                    displayRemainingBudget.classList.add('negative');
                } else {
                    displayRemainingBudget.classList.remove('negative');
                    displayRemainingBudget.classList.add('positive');
                }

                // Update progress bar
                let progressPercentage = 0;
                if (budgetGoal > 0) {
                    progressPercentage = (totalExpensesForMonth / budgetGoal) * 100;
                }
                progressPercentage = Math.min(progressPercentage, 100); // Cap at 100% for display

                budgetProgressBar.style.width = `${progressPercentage}%`;
                budgetProgressLabel.textContent = `${progressPercentage.toFixed(0)}% of budget used`;

                // Change progress bar color based on usage
                if (progressPercentage >= 100) {
                    budgetProgressBar.className = 'budget-progress-bar high-usage';
                } else if (progressPercentage >= 75) {
                    budgetProgressBar.className = 'budget-progress-bar medium-usage';
                } else {
                    budgetProgressBar.className = 'budget-progress-bar low-usage';
                }
            }

            function renderBudgetCategoryExpenses() {
                budgetCategoryExpensesList.innerHTML = '';
                const monthYearKey = getMonthYearKey(currentBudgetDate);
                const categoryExpenses = {};

                transactions.forEach(t => {
                    if (t.type === 'expense' && getMonthYearKey(new Date(t.date)) === monthYearKey) {
                        categoryExpenses[t.category] = (categoryExpenses[t.category] || 0) + t.amount;
                    }
                });

                const sortedCategories = Object.entries(categoryExpenses).sort(([, amountA], [, amountB]) => amountB - amountA);

                if (sortedCategories.length === 0) {
                    budgetCategoryExpensesList.appendChild(noBudgetCategoryExpensesMessage);
                    return;
                }

                sortedCategories.forEach(([category, amount]) => {
                    const listItem = document.createElement('li');
                    listItem.className = 'category-summary-item';
                    listItem.innerHTML = `
                        <span class="category-summary-name">${category}</span>
                        <span class="category-summary-amount">₹${amount.toFixed(2)}</span>
                    `;
                    budgetCategoryExpensesList.appendChild(listItem);
                });
            }

            // --- Form Handlers ---

            transactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = transactionIdInput.value || generateUniqueId();
                const type = document.querySelector('input[name="transaction-type"]:checked').value;
                const amount = parseFloat(transactionAmountInput.value);
                const description = transactionDescriptionInput.value.trim();
                const date = transactionDateInput.value;
                const category = transactionCategorySelect.value;

                if (isNaN(amount) || amount <= 0 || !description || !date || !category) {
                    alert('Please fill in all transaction fields correctly.');
                    return;
                }

                const existingIndex = transactions.findIndex(t => t.id === id);
                if (existingIndex > -1) {
                    // Update existing transaction
                    transactions[existingIndex] = { id, type, amount, description, date, category };
                } else {
                    // Add new transaction
                    transactions.push({ id, type, amount, description, date, category });
                }

                saveTransactions();
                resetTransactionForm();
                updateDashboard();
                updateBudgetView(); // Update budget view as well
                showView('dashboard-view');
            });

            addNewCategoryBtn.addEventListener('click', () => {
                const newCategoryName = newCategoryInput.value.trim();
                if (newCategoryName && !categories.has(newCategoryName)) {
                    categories.add(newCategoryName);
                    saveCategories();
                    renderCategories();
                    newCategoryInput.value = '';
                } else if (newCategoryName) {
                    alert('Category already exists!');
                }
            });

            applyFilterBtn.addEventListener('click', renderFilteredTransactions);
            clearFilterBtn.addEventListener('click', () => {
                filterStartDateInput.value = '';
                filterEndDateInput.value = '';
                filterCategorySelect.value = 'all';
                filterTypeSelect.value = 'all';
                renderFilteredTransactions(); // Re-render with cleared filters
            });

            borrowLentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = borrowLentIdInput.value || generateUniqueId();
                const type = document.querySelector('input[name="borrow-lent-type"]:checked').value;
                const amount = parseFloat(borrowLentAmountInput.value);
                const person = borrowLentPersonInput.value.trim();
                const date = borrowLentDateInput.value;
                const notes = borrowLentNotesInput.value.trim();
                const paid = borrowLentPaidCheckbox.checked;

                if (isNaN(amount) || amount <= 0 || !person || !date) {
                    alert('Please fill in all required fields for the record.');
                    return;
                }

                const existingIndex = borrowedLentRecords.findIndex(r => r.id === id);
                if (existingIndex > -1) {
                    borrowedLentRecords[existingIndex] = { id, type, amount, person, date, notes, paid };
                } else {
                    borrowedLentRecords.push({ id, type, amount, person, date, notes, paid });
                }

                saveBorrowedLentRecords();
                resetBorrowLentForm();
                renderBorrowedLentRecords();
                showView('borrowed-lent-view');
            });

            saveBudgetGoalBtn.addEventListener('click', () => {
                const monthYearKey = getMonthYearKey(currentBudgetDate);
                const newGoal = parseFloat(monthlyBudgetGoalInput.value);
                if (!isNaN(newGoal) && newGoal >= 0) {
                    monthlyBudgetGoals[monthYearKey] = newGoal;
                    saveMonthlyBudgetGoals();
                    updateBudgetView();
                    alert('Budget goal saved!');
                } else {
                    alert('Please enter a valid budget goal (a positive number).');
                }
            });

            // --- Edit & Delete Functions ---

            function editTransaction(id) {
                const transaction = transactions.find(t => t.id === id);
                if (transaction) {
                    transactionIdInput.value = transaction.id;
                    document.querySelector(`input[name="transaction-type"][value="${transaction.type}"]`).checked = true;
                    transactionAmountInput.value = transaction.amount;
                    transactionDescriptionInput.value = transaction.description;
                    transactionDateInput.value = transaction.date;
                    transactionCategorySelect.value = transaction.category;
                    saveTransactionBtn.textContent = 'Update Transaction';
                    showView('add-expense-view');
                }
            }

            function deleteTransaction(id) {
                if (confirm('Are you sure you want to delete this transaction?')) {
                    transactions = transactions.filter(t => t.id !== id);
                    saveTransactions();
                    updateDashboard();
                    updateBudgetView(); // Update budget view
                    renderFilteredTransactions(); // Re-render filtered list
                }
            }

            function deleteCategory(categoryName) {
                if (confirm(`Are you sure you want to delete the category "${categoryName}"? All transactions with this category will remain, but uncategorized.`)) {
                    categories.delete(categoryName);
                    // Optionally, update existing transactions with this category to a default or 'Uncategorized'
                    transactions.forEach(t => {
                        if (t.category === categoryName) {
                            t.category = 'Uncategorized'; // Or remove the category, depending on desired behavior
                        }
                    });
                    saveCategories();
                    saveTransactions(); // Save transactions after modifying categories
                    renderCategories();
                    updateDashboard(); // Refresh dashboard to reflect any category changes
                    updateBudgetView(); // Refresh budget view
                    renderFilteredTransactions(); // Refresh filtered view
                }
            }

            function editBorrowedLentRecord(id) {
                const record = borrowedLentRecords.find(r => r.id === id);
                if (record) {
                    borrowLentIdInput.value = record.id;
                    document.querySelector(`input[name="borrow-lent-type"][value="${record.type}"]`).checked = true;
                    borrowLentAmountInput.value = record.amount;
                    borrowLentPersonInput.value = record.person;
                    borrowLentDateInput.value = record.date;
                    borrowLentNotesInput.value = record.notes;
                    borrowLentPaidCheckbox.checked = record.paid;
                    saveBorrowLentBtn.textContent = 'Update Record';
                    showView('add-borrow-lent-view');
                }
            }

            function deleteBorrowedLentRecord(id) {
                if (confirm('Are you sure you want to delete this record?')) {
                    borrowedLentRecords = borrowedLentRecords.filter(r => r.id !== id);
                    saveBorrowedLentRecords();
                    renderBorrowedLentRecords();
                }
            }


            // --- UI Navigation & Reset ---

            function showView(viewId) {
                views.forEach(view => {
                    view.classList.remove('active');
                });
                document.getElementById(viewId).classList.add('active');

                // Update active nav item
                navItems.forEach(item => {
                    if (item.dataset.view === viewId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                // Run view-specific updates when a view becomes active
                if (viewId === 'dashboard-view') {
                    updateDashboard();
                } else if (viewId === 'categories-view') {
                    renderCategories();
                } else if (viewId === 'filtered-transactions-view') {
                    renderFilteredTransactions();
                } else if (viewId === 'borrowed-lent-view') {
                    renderBorrowedLentRecords();
                } else if (viewId === 'add-expense-view') {
                    populateCategorySelects(); // Ensure categories are loaded
                    transactionAmountInput.focus(); // Focus on amount input
                } else if (viewId === 'budget-view') { // NEW
                    updateBudgetView();
                }
            }

            function resetTransactionForm() {
                transactionForm.reset();
                transactionIdInput.value = '';
                document.getElementById('type-expense').checked = true; // Default to expense
                transactionAmountInput.value = '';
                transactionDescriptionInput.value = '';
                transactionDateInput.value = new Date().toISOString().slice(0, 10); // Set current date
                transactionCategorySelect.value = '';
                saveTransactionBtn.textContent = 'Add Transaction';
            }

            function resetBorrowedLentForm() {
                borrowLentForm.reset();
                borrowLentIdInput.value = '';
                document.getElementById('type-lent').checked = true;
                borrowLentAmountInput.value = '';
                borrowLentPersonInput.value = '';
                borrowLentDateInput.value = new Date().toISOString().slice(0, 10);
                borrowLentNotesInput.value = '';
                borrowLentPaidCheckbox.checked = false;
                saveBorrowLentBtn.textContent = 'Save Record';
            }

            // --- Date Formatting ---
            function formatDate(dateString) {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            }

            // For Budget View month/year display
            function formatMonthYear(date) {
                const options = { year: 'numeric', month: 'long' };
                return date.toLocaleDateString(undefined, options);
            }

            function getMonthYearKey(date) {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                return `${year}-${month}`;
            }

            // --- Event Listeners for Navigation ---
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const viewId = item.dataset.view;
                    showView(viewId);
                });
            });

            backToDashboardBtns.forEach(btn => {
                btn.addEventListener('click', () => showView('dashboard-view'));
            });

            addBorrowLentBtn.addEventListener('click', () => {
                resetBorrowLentForm();
                showView('add-borrow-lent-view');
            });

            if (backToBorrowLentBtn) {
                backToBorrowLentBtn.addEventListener('click', () => showView('borrowed-lent-view'));
            }


            // --- Theme Toggling ---
            themeToggleBtn.addEventListener('click', () => {
                document.body.classList.toggle('dark-theme');
                // Save theme preference to local storage
                if (document.body.classList.contains('dark-theme')) {
                    localStorage.setItem(LS_THEME, 'dark');
                } else {
                    localStorage.setItem(LS_THEME, 'light');
                }
            });

            function loadTheme() {
                const savedTheme = localStorage.getItem(LS_THEME);
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
            }


            // --- Calculator Functionality ---

            calculatorToggleBtn.addEventListener('click', () => {
                if (calculatorContainer.style.display === 'block') {
                    calculatorContainer.style.display = 'none';
                    resetCalculator();
                } else {
                    calculatorContainer.style.display = 'block';
                    calcOutput.value = '0';
                    firstOperand = null;
                    operator = null;
                    waitingForSecondOperand = false;
                }
            });

            calcButtons.addEventListener('click', (event) => {
                const { target } = event;
                if (!target.matches('button')) {
                    return;
                }

                const value = target.textContent;
                const action = target.dataset.action;

                if (target.classList.contains('number')) {
                    if (waitingForSecondOperand === true) {
                        calcOutput.value = value;
                        waitingForSecondOperand = false;
                    } else {
                        calcOutput.value = calcOutput.value === '0' ? value : calcOutput.value + value;
                    }
                } else if (target.classList.contains('decimal')) {
                    if (!calcOutput.value.includes('.')) {
                        calcOutput.value += '.';
                    }
                } else if (target.classList.contains('operator')) {
                    if (firstOperand === null) {
                        firstOperand = parseFloat(calcOutput.value);
                    } else if (operator) {
                        const result = operate(firstOperand, parseFloat(calcOutput.value), operator);
                        calcOutput.value = parseFloat(result.toFixed(5)); // To avoid long decimals
                        firstOperand = parseFloat(calcOutput.value);
                    }
                    operator = action;
                    waitingForSecondOperand = true;
                } else if (action === 'clear') {
                    resetCalculator();
                } else if (action === 'backspace') {
                    calcOutput.value = calcOutput.value.slice(0, -1) || '0';
                    if (calcOutput.value === '0') resetCalculator(); // If cleared to 0, reset state
                } else if (action === 'equals') {
                    if (firstOperand !== null && operator !== null && waitingForSecondOperand === false) {
                        const currentInput = calcOutput.value;
                        const result = operate(firstOperand, parseFloat(currentInput), operator);
                        calcOutput.value = parseFloat(result.toFixed(5));
                        currentInput = calcOutput.value;
                        firstOperand = null; // Clear for next calculation
                        operator = null;
                        waitingForSecondOperand = true; // Ready for new operation or number
                    }
                } else if (action === 'apply') {
                    // Modified apply logic to check which amount field is active
                    if (document.getElementById('add-expense-view').classList.contains('active')) {
                        transactionAmountInput.value = parseFloat(calcOutput.value);
                    } else if (document.getElementById('add-borrow-lent-view').classList.contains('active')) {
                        borrowLentAmountInput.value = parseFloat(calcOutput.value);
                    } else {
                        alert("Calculator result can only be applied to the 'Amount' field when adding/editing a transaction or borrowed/lent record.");
                    }
                    calculatorContainer.style.display = 'none'; // Hide calculator after applying
                    resetCalculator(); // Reset calculator for next use
                }
            });


            function operate(op1, op2, op) {
                switch (op) {
                    case 'add': return op1 + op2;
                    case 'subtract': return op1 - op2;
                    case 'multiply': return op1 * op2;
                    case 'divide': return op1 / op2;
                    default: return op2;
                }
            }

            function resetCalculator() {
                calcOutput.value = '0';
                firstOperand = null;
                operator = null;
                waitingForSecondOperand = false;
            }


            // --- Initialize on Load ---
            function initializeApp() {
                loadTheme();
                loadCategories();
                loadTransactions();
                loadBorrowedLentRecords();
                loadMonthlyBudgetGoals();
                resetTransactionForm(); // Set current date by default
                resetBorrowLentForm(); // Set current date by default
                showView('dashboard-view'); // Start on dashboard
                updateBudgetView(); // Initialize budget view for current month
            }

            initializeApp();
        });
    </script>
</body>
</html>
