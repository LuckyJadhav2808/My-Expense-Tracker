<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Expense Tracker</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="icon" type="image/png" href="expense 192.jpg" sizes="192x192">
    <link rel="icon" type="image/png" href="expense 512.jpg" sizes="512x512">
    <link rel="apple-touch-icon" href="expense 180.jpg">
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <i class="fas fa-sun toggle-theme-btn" id="themeToggle"></i>
            </div>
            <div class="header-center">
                <h1 class="app-title">Expense Tracker</h1>
            </div>
            <div class="header-right">
                <i class="fas fa-calculator toggle-calculator-btn" id="calculatorToggle"></i>
            </div>
        </header>

        <main class="main-content">
            <section id="dashboard-view" class="view active">
                <div class="balance-card">
                    <p class="balance-label">Current Balance</p>
                    <p class="balance-amount">₹ <span>0.00</span></p>
                </div>

                <div class="quick-actions">
                    <button class="action-btn" data-view="add-expense-view">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add New</span>
                    </button>
                    </div>

                <h2 class="section-title">Recent Transactions</h2>
                <ul class="transaction-list" id="recent-transaction-list">
                    <li class="no-transactions">No transactions yet! Add one to get started.</li>
                </ul>
            </section>

            <section id="add-expense-view" class="view">
                <h2 class="section-title">Add New Transaction</h2>
                <form id="expense-form" class="expense-form">
                    <input type="hidden" id="expense-id">
                    <div class="form-group">
                        <label for="transaction-type">Transaction Type</label>
                        <div class="transaction-type-selector">
                            <input type="radio" id="type-expense" name="transaction-type" value="expense" checked>
                            <label for="type-expense">Expense</label>
                            <input type="radio" id="type-income" name="transaction-type" value="income">
                            <label for="type-income">Income</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="expense-amount">Amount</label>
                        <input type="number" id="expense-amount" placeholder="e.g., 500" required step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="expense-description">Description</label>
                        <input type="text" id="expense-description" placeholder="e.g., Dinner with friends" required>
                    </div>
                     <div class="form-group">
                        <label for="expense-date">Date</label>
                        <input type="date" id="expense-date" value="" required>
                    </div>
                    <div class="form-group">
                        <label for="expense-category">Category</label>
                        <select id="expense-category" required>
                            <option value="">Select a category</option>
                        </select>
                    </div>
                    <button type="submit" class="primary-btn" id="save-expense-btn">Add Transaction</button>
                    <button type="button" class="secondary-btn back-to-dashboard-btn">Cancel</button>
                </form>
            </section>

            <section id="categories-view" class="view">
                <h2 class="section-title">Manage Categories</h2>
                <ul id="category-list" class="category-list">
                    </ul>
                <div class="add-category-section">
                    <input type="text" id="new-category-name" placeholder="New category name" class="new-category-input">
                    <button id="add-new-category-btn" class="primary-btn">Add Category</button>
                </div>
                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

            <section id="filtered-transactions-view" class="view">
                <h2 class="section-title">Filtered Transactions</h2>
                <div class="transaction-filters">
                    <input type="date" id="filter-start-date" placeholder="From Date">
                    <input type="date" id="filter-end-date" placeholder="To Date">
                    <select id="filter-category">
                        <option value="all">All Categories</option>
                        </select>
                    <select id="filter-type">
                        <option value="all">All Types</option>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                    <button class="secondary-btn small-btn" id="apply-filter-btn">Apply Filters</button>
                    <button class="secondary-btn small-btn" id="clear-filter-btn">Clear Filters</button>
                </div>
                <ul class="transaction-list" id="filtered-transaction-list">
                    <li class="no-transactions">Apply filters to see transactions.</li>
                </ul>
                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

            <section id="borrowed-lent-view" class="view">
                <h2 class="section-title">Borrowed/Lent Money</h2>
                <div class="summary-cards">
                    <div class="summary-card owed">
                        <h3>Money Owed to You</h3>
                        <p class="amount">₹ <span id="total-lent">0.00</span></p>
                    </div>
                    <div class="summary-card owing">
                        <h3>Money You Owe</h3>
                        <p class="amount">₹ <span id="total-borrowed">0.00</span></p>
                    </div>
                </div>

                <button class="primary-btn" id="add-borrow-lent-btn">Add Record</button>

                <h3 class="subsection-title">All Records</h3>
                <ul class="borrowed-lent-list" id="borrowed-lent-list">
                    <li class="no-records">No borrowed/lent records yet.</li>
                </ul>
                 <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

            <section id="add-borrow-lent-view" class="view">
                <h2 class="section-title">Add/Edit Money Record</h2>
                <form id="borrow-lent-form" class="expense-form">
                    <input type="hidden" id="borrow-lent-id">
                    <div class="form-group">
                        <label for="borrow-lent-type">Record Type</label>
                        <div class="transaction-type-selector">
                            <input type="radio" id="type-lent" name="borrow-lent-type" value="lent" checked>
                            <label for="type-lent">Money Lent</label>
                            <input type="radio" id="type-borrowed" name="borrow-lent-type" value="borrowed">
                            <label for="type-borrowed">Money Borrowed</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-amount">Amount</label>
                        <input type="number" id="borrow-lent-amount" placeholder="e.g., 200" required step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-person">Person/Party</label>
                        <input type="text" id="borrow-lent-person" placeholder="e.g., John Doe" required>
                    </div>
                     <div class="form-group">
                        <label for="borrow-lent-date">Date</label>
                        <input type="date" id="borrow-lent-date" value="" required>
                    </div>
                    <div class="form-group">
                        <label for="borrow-lent-notes">Notes (Optional)</label>
                        <textarea id="borrow-lent-notes" rows="3" placeholder="e.g., For lunch"></textarea>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="borrow-lent-paid">
                        <label for="borrow-lent-paid">Mark as Paid/Returned</label>
                    </div>
                    <button type="submit" class="primary-btn" id="save-borrow-lent-btn">Save Record</button>
                    <button type="button" class="secondary-btn back-to-borrow-lent-btn">Cancel</button>
                </form>
            </section>

            <section id="budget-view" class="view">
                <h2 class="section-title">Monthly Budget</h2>
                <div class="budget-controls">
                    <button id="prev-month-btn" class="icon-btn"><i class="fas fa-chevron-left"></i></button>
                    <span id="current-budget-month" class="month-display">July 2025</span>
                    <button id="next-month-btn" class="icon-btn"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div class="form-group budget-goal-input-group">
                    <label for="monthly-budget-goal">Set Monthly Budget Goal (₹)</label>
                    <input type="number" id="monthly-budget-goal" placeholder="e.g., 10000" step="0.01">
                    <button id="save-budget-goal-btn" class="primary-btn small-btn">Save</button>
                </div>

                <div class="budget-summary-card">
                    <div class="summary-item">
                        <p class="summary-label">Budget Goal</p>
                        <p class="summary-value budget-goal">₹ <span id="display-budget-goal">0.00</span></p>
                    </div>
                    <div class="summary-item">
                        <p class="summary-label">Total Expenses</p>
                        <p class="summary-value total-expenses">₹ <span id="display-total-expenses">0.00</span></p>
                    </div>
                    <div class="summary-item">
                        <p class="summary-label">Remaining Budget</p>
                        <p class="summary-value remaining-budget">₹ <span id="display-remaining-budget" class="positive">0.00</span></p>
                    </div>
                </div>

                <div class="budget-progress-bar-container">
                    <div class="budget-progress-bar" id="budget-progress-bar"></div>
                </div>
                <p class="progress-label" id="budget-progress-label">0% of budget used</p>

                <h3 class="subsection-title">Expenses by Category for this Month</h3>
                <ul id="budget-category-expenses-list" class="category-summary-list">
                    <li class="no-categories">No expenses for this month.</li>
                </ul>

                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

            <section id="monthly-summary-view" class="view">
                <h2 class="section-title">Monthly Expense History</h2>
                <ul id="monthly-summary-list" class="monthly-summary-list">
                    <li class="no-summaries">No monthly summaries saved yet.</li>
                </ul>
                <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>

            <section id="backup-view" class="view">
                <h2 class="section-title">Data Backup & Restore</h2>
                <div class="backup-restore-actions">
                    <button class="primary-btn" id="backup-data-btn">
                        <i class="fas fa-download"></i>
                        <span>Backup Data</span>
                    </button>
                    <button class="secondary-btn" id="restore-data-btn">
                        <i class="fas fa-upload"></i>
                        <span>Restore Data</span>
                    </button>
                     <button class="secondary-btn" id="force-monthly-summary-btn">
                        <i class="fas fa-calendar-check"></i>
                        <span>Force Monthly Summary</span>
                    </button>
                </div>
                 <button type="button" class="secondary-btn back-to-dashboard-btn">Back to Dashboard</button>
            </section>


        </main>

        <div id="calculator" class="calculator-container" style="display: none;">
            <div class="calculator-display">
                <input type="text" id="calc-output" readonly value="0">
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn clear" data-action="clear">C</button>
                <button class="calc-btn operator" data-action="divide">/</button>
                <button class="calc-btn operator" data-action="multiply">*</button>
                <button class="calc-btn backspace" data-action="backspace"><i class="fas fa-backspace"></i></button>

                <button class="calc-btn number">7</button>
                <button class="calc-btn number">8</button>
                <button class="calc-btn number">9</button>
                <button class="calc-btn operator" data-action="subtract">-</button>

                <button class="calc-btn number">4</button>
                <button class="calc-btn number">5</button>
                <button class="calc-btn number">6</button>
                <button class="calc-btn operator" data-action="add">+</button>

                <button class="calc-btn number">1</button>
                <button class="calc-btn number">2</button>
                <button class="calc-btn number">3</button>
                <button class="calc-btn equals" data-action="equals">=</button>

                <button class="calc-btn number zero">0</button>
                <button class="calc-btn number decimal">.</button>
                <button class="calc-btn apply-calc" data-action="apply">Apply</button>
            </div>
        </div>

        <nav class="bottom-nav">
            <button class="nav-item active" data-view="dashboard-view">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-item" data-view="add-expense-view">
                <i class="fas fa-plus-circle"></i>
                <span>Add</span>
            </button>
            <button class="nav-item" data-view="categories-view">
                <i class="fas fa-tags"></i>
                <span>Categories</span>
            </button>
            <button class="nav-item" data-view="filtered-transactions-view">
                <i class="fas fa-filter"></i>
                <span>Filter</span>
            </button>
            <button class="nav-item" data-view="borrowed-lent-view">
                <i class="fas fa-hand-holding-dollar"></i>
                <span>Debts</span>
            </button>
            <button class="nav-item" data-view="budget-view">
                <i class="fas fa-chart-pie"></i>
                <span>Budget</span>
            </button>
            <button class="nav-item" data-view="monthly-summary-view">
                <i class="fas fa-calendar-alt"></i>
                <span>History</span>
            </button>
            <button class="nav-item" data-view="backup-view">
                <i class="fas fa-database"></i>
                <span>Backup</span>
            </button>
        </nav>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const appContainer = document.querySelector('.app-container');
            const mainContent = document.querySelector('.main-content');
            const navItems = document.querySelectorAll('.bottom-nav .nav-item');
            const views = document.querySelectorAll('.view');
            const backToDashboardBtns = document.querySelectorAll('.back-to-dashboard-btn');
            const quickActionBtns = document.querySelectorAll('.quick-actions .action-btn'); // Only "Add New" remains

            // Dashboard elements
            const balanceAmountSpan = document.querySelector('.balance-amount span');
            const recentTransactionList = document.getElementById('recent-transaction-list');
            const noRecentTransactionsMessage = recentTransactionList.querySelector('.no-transactions');

            // Monthly Summaries elements
            const monthlySummaryList = document.getElementById('monthly-summary-list');
            const noSummariesMessage = monthlySummaryList.querySelector('.no-summaries');

            // Add Transaction elements (formerly Add Expense)
            const transactionForm = document.getElementById('expense-form'); // Retain ID for now
            const transactionIdInput = document.getElementById('expense-id'); // For future edit functionality
            const transactionTypeRadios = document.querySelectorAll('input[name="transaction-type"]');
            const transactionAmountInput = document.getElementById('expense-amount');
            const transactionDescriptionInput = document.getElementById('expense-description');
            const transactionDateInput = document.getElementById('expense-date');
            const transactionCategorySelect = document.getElementById('expense-category');
            const saveTransactionBtn = document.getElementById('save-expense-btn'); // Retain ID for now

            // Categories elements
            const categoryListUl = document.getElementById('category-list');
            const newCategoryInput = document.getElementById('new-category-name');
            const addNewCategoryBtn = document.getElementById('add-new-category-btn');

            // Filtered Transactions elements
            const filteredTransactionList = document.getElementById('filtered-transaction-list');
            const noFilteredTransactionsMessage = filteredTransactionList.querySelector('.no-transactions');
            const filterStartDateInput = document.getElementById('filter-start-date');
            const filterEndDateInput = document.getElementById('filter-end-date');
            const filterCategorySelect = document.getElementById('filter-category');
            const filterTypeSelect = document.getElementById('filter-type');
            const applyFilterBtn = document.getElementById('apply-filter-btn');
            const clearFilterBtn = document.getElementById('clear-filter-btn');

            // Borrowed/Lent elements
            const totalLentSpan = document.getElementById('total-lent');
            const totalBorrowedSpan = document.getElementById('total-borrowed');
            const addBorrowLentBtn = document.getElementById('add-borrow-lent-btn');
            const borrowedLentListUl = document.getElementById('borrowed-lent-list');
            const noBorrowedLentRecordsMessage = borrowedLentListUl.querySelector('.no-records');

            // Add/Edit Borrowed/Lent Form elements
            const borrowLentForm = document.getElementById('borrow-lent-form');
            const borrowLentIdInput = document.getElementById('borrow-lent-id');
            const borrowLentTypeRadios = document.querySelectorAll('input[name="borrow-lent-type"]');
            const borrowLentAmountInput = document.getElementById('borrow-lent-amount');
            const borrowLentPersonInput = document.getElementById('borrow-lent-person');
            const borrowLentDateInput = document.getElementById('borrow-lent-date');
            const borrowLentNotesInput = document.getElementById('borrow-lent-notes');
            const borrowLentPaidCheckbox = document.getElementById('borrow-lent-paid');
            const saveBorrowLentBtn = document.getElementById('save-borrow-lent-btn');
            const backToBorrowLentBtn = document.querySelector('#add-borrow-lent-view .back-to-borrow-lent-btn'); // Specific back button for borrow/lent form


            // Budget Section Elements
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const currentBudgetMonthDisplay = document.getElementById('current-budget-month');
            const monthlyBudgetGoalInput = document.getElementById('monthly-budget-goal');
            const saveBudgetGoalBtn = document.getElementById('save-budget-goal-btn');
            const displayBudgetGoal = document.getElementById('display-budget-goal');
            const displayTotalExpenses = document.getElementById('display-total-expenses');
            const displayRemainingBudget = document.getElementById('display-remaining-budget');
            const budgetProgressBar = document.getElementById('budget-progress-bar');
            const budgetProgressLabel = document.getElementById('budget-progress-label');
            const budgetCategoryExpensesList = document.getElementById('budget-category-expenses-list');
            const noBudgetCategoryExpensesMessage = budgetCategoryExpensesList.querySelector('.no-categories');

            // Theme toggle
            const themeToggleBtn = document.getElementById('themeToggle');

            // Calculator Elements
            const calculatorToggleBtn = document.getElementById('calculatorToggle');
            const calculatorContainer = document.getElementById('calculator');
            const calcOutput = document.getElementById('calc-output');
            const calcButtons = calculatorContainer.querySelector('.calculator-buttons');
            let currentInput = '0';
            let firstOperand = null;
            let operator = null;
            let waitingForSecondOperand = false;

            // Backup/Restore buttons (moved to #backup-view)
            const backupDataBtn = document.getElementById('backup-data-btn');
            const restoreDataBtn = document.getElementById('restore-data-btn');
            const forceMonthlySummaryBtn = document.getElementById('force-monthly-summary-btn');

            // --- Data Storage (Using localStorage) ---
            let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            let categories = JSON.parse(localStorage.getItem('categories')) || ['Food', 'Transport', 'Study', 'Entertainment', 'Rent', 'Utilities', 'Shopping', 'Others'];
            let borrowedLentRecords = JSON.parse(localStorage.getItem('borrowedLentRecords')) || [];
            let currentTheme = localStorage.getItem('theme') || 'light';
            let monthlyBudgets = JSON.parse(localStorage.getItem('monthlyBudgets')) || {};
            let currentBudgetMonth = new Date(); // Tracks the month currently displayed in the budget section
            let monthlySummaries = JSON.parse(localStorage.getItem('monthlySummaries')) || [];

            // --- Global Filtering State for the Filtered Transactions Section ---
            let currentFilter = { startDate: null, endDate: null, category: 'all', type: 'all' };

            // --- Utility Functions ---
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }

            function saveData() {
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('categories', JSON.stringify(categories));
                localStorage.setItem('borrowedLentRecords', JSON.stringify(borrowedLentRecords));
                localStorage.setItem('monthlyBudgets', JSON.stringify(monthlyBudgets));
                localStorage.setItem('monthlySummaries', JSON.stringify(monthlySummaries));
            }

            function formatDate(dateString) {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            }

            function formatCurrency(amount) {
                return parseFloat(amount).toFixed(2);
            }

            // Function to check and save monthly summary
            const checkAndSaveMonthlySummary = () => {
                const now = new Date();
                const currentMonthYear = `${now.getFullYear()}-${now.getMonth()}`;

                // Get the last known date from local storage
                let lastDateString = localStorage.getItem('lastCheckDate');
                let lastCheckDate = lastDateString ? new Date(lastDateString) : now;

                // Check if the month has changed
                if (now.getMonth() !== lastCheckDate.getMonth() || now.getFullYear() !== lastCheckDate.getFullYear()) {
                    // A new month has started!
                    console.log('New month detected. Saving summary and resetting data.');

                    // Calculate current month's stats
                    const totalExpenses = transactions.filter(t => t.type === 'expense')
                                                       .reduce((sum, t) => sum + t.amount, 0);
                    const totalIncome = transactions.filter(t => t.type === 'income')
                                                      .reduce((sum, t) => sum + t.amount, 0);
                    const finalBalance = totalIncome - totalExpenses;

                    // Create a summary object
                    const summary = {
                        monthYear: `${lastCheckDate.toLocaleString('default', { month: 'long' })} ${lastCheckDate.getFullYear()}`,
                        totalExpenses: totalExpenses,
                        totalIncome: totalIncome,
                        finalBalance: finalBalance,
                        transactions: transactions // You might want to save all transactions for the month
                    };

                    // Save the summary to the monthlySummaries array
                    monthlySummaries.unshift(summary); // Add to the beginning of the array
                    
                    // Reset transactions for the new month
                    transactions = [];

                    // Update local storage
                    saveData();
                }

                // Always save the current date to localStorage for the next check
                localStorage.setItem('lastCheckDate', now.toISOString());
            };

            // --- Initial Setup Functions ---
            function initializeApp() {
                checkAndSaveMonthlySummary(); // Check and save monthly summary on app load
                applyTheme(currentTheme);
                populateCategorySelects();
                updateBalance();
                displayRecentTransactions();
                transactionDateInput.valueAsDate = new Date();
                setDefaultFilterDates();
                updateBorrowedLentSummary();
                displayBorrowedLentRecords();
                borrowLentDateInput.valueAsDate = new Date();
                calculatorContainer.style.display = 'none';
                resetCalculator();
                initializeBudgetSection();
                displayMonthlySummaries(); // Call the new function
            }

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                    themeToggleBtn.classList.remove('fa-sun');
                    themeToggleBtn.classList.add('fa-moon');
                } else {
                    document.body.classList.remove('dark-theme');
                    themeToggleBtn.classList.remove('fa-moon');
                    themeToggleBtn.classList.add('fa-sun');
                }
                currentTheme = theme;
                localStorage.setItem('theme', theme);
            }

            function switchView(viewId) {
                views.forEach(view => {
                    view.classList.remove('active');
                });
                document.getElementById(viewId).classList.add('active');
                navItems.forEach(item => {
                    if (item.dataset.view === viewId) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });

                // Specific actions on view switch
                if (viewId === 'dashboard-view') {
                    updateBalance();
                    displayRecentTransactions();
                } else if (viewId === 'categories-view') {
                    displayCategoriesList();
                    populateCategorySelects();
                } else if (viewId === 'add-expense-view') {
                    resetTransactionForm();
                    populateCategorySelects();
                } else if (viewId === 'filtered-transactions-view') {
                    populateCategorySelects();
                    displayFilteredTransactions();
                } else if (viewId === 'borrowed-lent-view') {
                    updateBorrowedLentSummary();
                    displayBorrowedLentRecords();
                } else if (viewId === 'add-borrow-lent-view') {
                    resetBorrowLentForm();
                } else if (viewId === 'budget-view') {
                    updateBudgetDisplay();
                } else if (viewId === 'monthly-summary-view') {
                    displayMonthlySummaries();
                }
            }

            // --- Dashboard Functionality ---
            function updateBalance() {
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const currentBalance = totalIncome - totalExpenses;
                balanceAmountSpan.textContent = formatCurrency(currentBalance);
            }

            function displayRecentTransactions() {
                recentTransactionList.innerHTML = '';
                if (transactions.length === 0) {
                    recentTransactionList.appendChild(noRecentTransactionsMessage);
                    noRecentTransactionsMessage.style.display = 'block';
                    return;
                }
                noRecentTransactionsMessage.style.display = 'none';
                const sortedTransactions = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
                const recentFive = sortedTransactions.slice(0, 5);
                recentFive.forEach(t => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('transaction-item', t.type);
                    listItem.innerHTML = `
                        <div class="transaction-icon">
                            <i class="${t.type === 'expense' ? 'fas fa-minus-circle' : 'fas fa-plus-circle'}"></i>
                        </div>
                        <div class="transaction-info">
                            <p class="transaction-description">${t.description}</p>
                            <p class="transaction-date">${formatDate(t.date)}</p>
                            <p class="transaction-category">${t.category}</p>
                        </div>
                        <div class="transaction-amount">₹ ${formatCurrency(t.amount)}</div>
                        <div class="transaction-actions">
                            <button class="edit-btn" data-id="${t.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" data-id="${t.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    recentTransactionList.appendChild(listItem);
                });
                recentTransactionList.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => editTransaction(e.currentTarget.dataset.id));
                });
                recentTransactionList.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => deleteTransaction(e.currentTarget.dataset.id));
                });
            }

            // --- Monthly Summary Functionality ---
            function displayMonthlySummaries() {
                monthlySummaryList.innerHTML = '';
                if (monthlySummaries.length === 0) {
                    const noSummariesLi = document.createElement('li');
                    noSummariesLi.className = 'no-summaries';
                    noSummariesLi.textContent = 'No monthly summaries saved yet.';
                    monthlySummaryList.appendChild(noSummariesLi);
                    return;
                }
                monthlySummaries.forEach(summary => {
                    const li = document.createElement('li');
                    li.className = 'monthly-summary-item';
                    li.innerHTML = `
                        <div class="month-header">
                            <h3>${summary.monthYear}</h3>
                            <span class="month-total">Total Expenses: ₹ ${summary.totalExpenses.toFixed(2)}</span>
                        </div>
                        <div class="monthly-summary-details">
                            <p>Total Income: ₹ ${summary.totalIncome.toFixed(2)}</p>
                            <p>Final Balance: ₹ ${summary.finalBalance.toFixed(2)}</p>
                        </div>
                    `;
                    monthlySummaryList.appendChild(li);
                });
            }

            // --- Add/Edit Transaction Functionality ---
            function populateCategorySelects() {
                const selects = document.querySelectorAll('#expense-category, #filter-category');
                selects.forEach(select => {
                    const selectedValue = select.value;
                    select.innerHTML = select.id === 'filter-category' ? '<option value="all">All Categories</option>' : '<option value="">Select a category</option>';
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        select.appendChild(option);
                    });
                    if (selectedValue) {
                        select.value = selectedValue;
                    }
                });
            }

            function resetTransactionForm() {
                transactionForm.reset();
                transactionIdInput.value = '';
                saveTransactionBtn.textContent = 'Add Transaction';
                transactionTypeRadios[0].checked = true;
                transactionDateInput.valueAsDate = new Date();
                populateCategorySelects();
            }

            function addOrUpdateTransaction(e) {
                e.preventDefault();
                const id = transactionIdInput.value;
                const type = document.querySelector('input[name="transaction-type"]:checked').value;
                const amount = parseFloat(transactionAmountInput.value);
                const description = transactionDescriptionInput.value;
                const date = transactionDateInput.value;
                const category = transactionCategorySelect.value;

                if (amount <= 0 || !description || !date || !category) {
                    alert('Please fill out all fields with valid data.');
                    return;
                }

                if (id) {
                    // Edit existing transaction
                    const index = transactions.findIndex(t => t.id === id);
                    if (index !== -1) {
                        transactions[index] = { ...transactions[index], type, amount, description, date, category };
                    }
                } else {
                    // Add new transaction
                    const newTransaction = { id: generateId(), type, amount, description, date, category };
                    transactions.push(newTransaction);
                }

                saveData();
                resetTransactionForm();
                switchView('dashboard-view');
            }

            function editTransaction(id) {
                const transactionToEdit = transactions.find(t => t.id === id);
                if (transactionToEdit) {
                    transactionIdInput.value = transactionToEdit.id;
                    document.getElementById(`type-${transactionToEdit.type}`).checked = true;
                    transactionAmountInput.value = transactionToEdit.amount;
                    transactionDescriptionInput.value = transactionToEdit.description;
                    transactionDateInput.value = transactionToEdit.date;
                    transactionCategorySelect.value = transactionToEdit.category;
                    saveTransactionBtn.textContent = 'Save Changes';
                    switchView('add-expense-view');
                }
            }

            function deleteTransaction(id) {
                if (confirm('Are you sure you want to delete this transaction?')) {
                    transactions = transactions.filter(t => t.id !== id);
                    saveData();
                    updateBalance();
                    displayRecentTransactions();
                }
            }

            // --- Categories Functionality ---
            function displayCategoriesList() {
                categoryListUl.innerHTML = '';
                categories.forEach(category => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('category-item');
                    listItem.innerHTML = `
                        <span>${category}</span>
                        <button class="delete-category-btn" data-category="${category}"><i class="fas fa-trash-alt"></i></button>
                    `;
                    categoryListUl.appendChild(listItem);
                });
            }

            function addCategory() {
                const newCatName = newCategoryInput.value.trim();
                if (newCatName && !categories.includes(newCatName)) {
                    categories.push(newCatName);
                    saveData();
                    displayCategoriesList();
                    populateCategorySelects();
                    newCategoryInput.value = '';
                } else if (newCatName) {
                    alert('This category already exists!');
                }
            }

            function deleteCategory(categoryToDelete) {
                if (confirm(`Are you sure you want to delete the category "${categoryToDelete}"? All associated transactions will remain uncategorized.`)) {
                    categories = categories.filter(cat => cat !== categoryToDelete);
                    saveData();
                    displayCategoriesList();
                    populateCategorySelects();
                }
            }

            // --- Filtered Transactions Functionality ---
            function setDefaultFilterDates() {
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filterStartDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
                filterEndDateInput.value = now.toISOString().split('T')[0];
            }

            function displayFilteredTransactions() {
                filteredTransactionList.innerHTML = '';
                let filtered = [...transactions];
                if (currentFilter.startDate) {
                    filtered = filtered.filter(t => new Date(t.date) >= new Date(currentFilter.startDate));
                }
                if (currentFilter.endDate) {
                    filtered = filtered.filter(t => new Date(t.date) <= new Date(currentFilter.endDate));
                }
                if (currentFilter.category !== 'all') {
                    filtered = filtered.filter(t => t.category === currentFilter.category);
                }
                if (currentFilter.type !== 'all') {
                    filtered = filtered.filter(t => t.type === currentFilter.type);
                }

                if (filtered.length === 0) {
                    filteredTransactionList.appendChild(noFilteredTransactionsMessage);
                    noFilteredTransactionsMessage.style.display = 'block';
                    return;
                }
                noFilteredTransactionsMessage.style.display = 'none';

                filtered.forEach(t => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('transaction-item', t.type);
                    listItem.innerHTML = `
                        <div class="transaction-info">
                            <p class="transaction-description">${t.description}</p>
                            <p class="transaction-date">${formatDate(t.date)}</p>
                            <p class="transaction-category">${t.category}</p>
                        </div>
                        <div class="transaction-amount">₹ ${t.type === 'expense' ? '-' : '+'}${formatCurrency(t.amount)}</div>
                    `;
                    filteredTransactionList.appendChild(listItem);
                });
            }

            function applyFilters() {
                currentFilter.startDate = filterStartDateInput.value;
                currentFilter.endDate = filterEndDateInput.value;
                currentFilter.category = filterCategorySelect.value;
                currentFilter.type = filterTypeSelect.value;
                displayFilteredTransactions();
            }

            function clearFilters() {
                currentFilter = { startDate: null, endDate: null, category: 'all', type: 'all' };
                filterStartDateInput.value = '';
                filterEndDateInput.value = '';
                filterCategorySelect.value = 'all';
                filterTypeSelect.value = 'all';
                displayFilteredTransactions();
            }

            // --- Borrowed/Lent Functionality ---
            function updateBorrowedLentSummary() {
                const totalLent = borrowedLentRecords.filter(r => r.type === 'lent' && !r.isPaid).reduce((sum, r) => sum + parseFloat(r.amount), 0);
                const totalBorrowed = borrowedLentRecords.filter(r => r.type === 'borrowed' && !r.isPaid).reduce((sum, r) => sum + parseFloat(r.amount), 0);
                totalLentSpan.textContent = formatCurrency(totalLent);
                totalBorrowedSpan.textContent = formatCurrency(totalBorrowed);
            }

            function displayBorrowedLentRecords() {
                borrowedLentListUl.innerHTML = '';
                if (borrowedLentRecords.length === 0) {
                    borrowedLentListUl.appendChild(noBorrowedLentRecordsMessage);
                    noBorrowedLentRecordsMessage.style.display = 'block';
                    return;
                }
                noBorrowedLentRecordsMessage.style.display = 'none';

                const sortedRecords = [...borrowedLentRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedRecords.forEach(record => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('borrowed-lent-item', record.type);
                    if (record.isPaid) {
                        listItem.classList.add('paid');
                    }
                    listItem.innerHTML = `
                        <div class="record-info">
                            <p class="record-description">${record.type === 'lent' ? 'Lent to' : 'Borrowed from'} ${record.person}</p>
                            <p class="record-date">${formatDate(record.date)}</p>
                            <p class="record-notes">${record.notes || ''}</p>
                        </div>
                        <div class="record-amount">₹ ${formatCurrency(record.amount)}</div>
                        <div class="record-actions">
                            <button class="mark-paid-btn" data-id="${record.id}" ${record.isPaid ? 'disabled' : ''}>
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="delete-borrow-lent-btn" data-id="${record.id}"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    borrowedLentListUl.appendChild(listItem);
                });

                borrowedLentListUl.querySelectorAll('.mark-paid-btn').forEach(button => {
                    button.addEventListener('click', (e) => markBorrowedLentPaid(e.currentTarget.dataset.id));
                });
                borrowedLentListUl.querySelectorAll('.delete-borrow-lent-btn').forEach(button => {
                    button.addEventListener('click', (e) => deleteBorrowedLentRecord(e.currentTarget.dataset.id));
                });
            }

            function resetBorrowLentForm() {
                borrowLentForm.reset();
                borrowLentIdInput.value = '';
                borrowLentTypeRadios[0].checked = true;
                borrowLentDateInput.valueAsDate = new Date();
                borrowLentPaidCheckbox.checked = false;
                saveBorrowLentBtn.textContent = 'Save Record';
            }

            function addOrUpdateBorrowLent(e) {
                e.preventDefault();
                const id = borrowLentIdInput.value;
                const type = document.querySelector('input[name="borrow-lent-type"]:checked').value;
                const amount = parseFloat(borrowLentAmountInput.value);
                const person = borrowLentPersonInput.value;
                const date = borrowLentDateInput.value;
                const notes = borrowLentNotesInput.value;
                const isPaid = borrowLentPaidCheckbox.checked;

                if (amount <= 0 || !person || !date) {
                    alert('Please fill out all required fields.');
                    return;
                }

                if (id) {
                    const index = borrowedLentRecords.findIndex(r => r.id === id);
                    if (index !== -1) {
                        borrowedLentRecords[index] = { ...borrowedLentRecords[index], type, amount, person, date, notes, isPaid };
                    }
                } else {
                    const newRecord = { id: generateId(), type, amount, person, date, notes, isPaid };
                    borrowedLentRecords.push(newRecord);
                }
                saveData();
                resetBorrowLentForm();
                switchView('borrowed-lent-view');
            }

            function markBorrowedLentPaid(id) {
                const record = borrowedLentRecords.find(r => r.id === id);
                if (record) {
                    record.isPaid = true;
                    saveData();
                    displayBorrowedLentRecords();
                    updateBorrowedLentSummary();
                }
            }

            function deleteBorrowedLentRecord(id) {
                if (confirm('Are you sure you want to delete this record?')) {
                    borrowedLentRecords = borrowedLentRecords.filter(r => r.id !== id);
                    saveData();
                    displayBorrowedLentRecords();
                    updateBorrowedLentSummary();
                }
            }

            // --- Budget Functionality ---
            function updateBudgetDisplay() {
                const monthYear = `${currentBudgetMonth.getFullYear()}-${currentBudgetMonth.getMonth()}`;
                const budgetGoal = monthlyBudgets[monthYear] ? monthlyBudgets[monthYear] : 0;
                const monthlyExpenses = transactions.filter(t => t.type === 'expense' && t.date.startsWith(currentBudgetMonth.toISOString().slice(0, 7)))
                                                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const remainingBudget = budgetGoal - monthlyExpenses;
                const progressPercentage = budgetGoal > 0 ? (monthlyExpenses / budgetGoal) * 100 : 0;

                currentBudgetMonthDisplay.textContent = currentBudgetMonth.toLocaleString('default', { month: 'long', year: 'numeric' });
                monthlyBudgetGoalInput.value = budgetGoal > 0 ? budgetGoal : '';
                displayBudgetGoal.textContent = formatCurrency(budgetGoal);
                displayTotalExpenses.textContent = formatCurrency(monthlyExpenses);
                displayRemainingBudget.textContent = formatCurrency(remainingBudget);
                displayRemainingBudget.classList.toggle('negative', remainingBudget < 0);
                displayRemainingBudget.classList.toggle('positive', remainingBudget >= 0);
                
                budgetProgressBar.style.width = `${Math.min(progressPercentage, 100)}%`;
                budgetProgressBar.classList.toggle('over-budget', progressPercentage > 100);
                budgetProgressLabel.textContent = `${Math.round(Math.min(progressPercentage, 100))}% of budget used`;

                displayBudgetCategoryExpenses(currentBudgetMonth.toISOString().slice(0, 7));
            }

            function displayBudgetCategoryExpenses(monthPrefix) {
                const monthlyExpenses = transactions.filter(t => t.type === 'expense' && t.date.startsWith(monthPrefix));
                const expensesByCategory = monthlyExpenses.reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + parseFloat(t.amount);
                    return acc;
                }, {});

                budgetCategoryExpensesList.innerHTML = '';
                const sortedCategories = Object.keys(expensesByCategory).sort();

                if (sortedCategories.length === 0) {
                    const noCategoriesLi = document.createElement('li');
                    noCategoriesLi.className = 'no-categories';
                    noCategoriesLi.textContent = 'No expenses for this month.';
                    budgetCategoryExpensesList.appendChild(noCategoriesLi);
                    return;
                }

                sortedCategories.forEach(category => {
                    const total = expensesByCategory[category];
                    const listItem = document.createElement('li');
                    listItem.className = 'category-summary-item';
                    listItem.innerHTML = `
                        <span>${category}</span>
                        <span>₹ ${formatCurrency(total)}</span>
                    `;
                    budgetCategoryExpensesList.appendChild(listItem);
                });
            }

            function initializeBudgetSection() {
                const now = new Date();
                currentBudgetMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                updateBudgetDisplay();
            }

            // --- Backup/Restore Functionality ---
            function backupData() {
                const data = {
                    transactions: transactions,
                    categories: categories,
                    borrowedLentRecords: borrowedLentRecords,
                    monthlyBudgets: monthlyBudgets,
                    monthlySummaries: monthlySummaries
                };
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `expense_tracker_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function restoreData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = e => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const importedData = JSON.parse(event.target.result);
                            if (importedData.transactions && importedData.categories && importedData.borrowedLentRecords && importedData.monthlyBudgets && importedData.monthlySummaries) {
                                if (confirm('Are you sure you want to restore? This will overwrite all your current data.')) {
                                    transactions = importedData.transactions;
                                    categories = importedData.categories;
                                    borrowedLentRecords = importedData.borrowedLentRecords;
                                    monthlyBudgets = importedData.monthlyBudgets;
                                    monthlySummaries = importedData.monthlySummaries;
                                    saveData();
                                    initializeApp();
                                    alert('Data restored successfully!');
                                    switchView('dashboard-view');
                                }
                            } else {
                                alert('Invalid file format. Please upload a valid expense tracker backup file.');
                            }
                        } catch (error) {
                            alert('Error reading file. Please ensure it is a valid JSON file.');
                            console.error('Restore failed:', error);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            // --- Calculator Functionality ---
            function calculate(operator, firstOperand, secondOperand) {
                switch (operator) {
                    case '+': return firstOperand + secondOperand;
                    case '-': return firstOperand - secondOperand;
                    case '*': return firstOperand * secondOperand;
                    case '/': return firstOperand / secondOperand;
                    default: return secondOperand;
                }
            }

            function resetCalculator() {
                currentInput = '0';
                firstOperand = null;
                operator = null;
                waitingForSecondOperand = false;
                calcOutput.value = currentInput;
            }

            function handleCalculatorInput(e) {
                const { target } = e;
                if (!target.matches('button')) { return; }

                const value = target.textContent;
                const action = target.dataset.action;

                if (action === 'clear') {
                    resetCalculator();
                    return;
                }

                if (action === 'backspace') {
                    currentInput = currentInput.slice(0, -1) || '0';
                    calcOutput.value = currentInput;
                    return;
                }

                if (action === 'equals') {
                    if (firstOperand !== null && operator !== null && waitingForSecondOperand) {
                        currentInput = calculate(operator, firstOperand, parseFloat(currentInput)).toString();
                        calcOutput.value = currentInput;
                        firstOperand = null;
                        operator = null;
                        waitingForSecondOperand = false;
                    }
                    return;
                }

                if (action === 'apply') {
                    const activeInput = document.querySelector('.view.active input[type="number"], .view.active input[type="text"]');
                    if (activeInput) {
                        activeInput.value = currentInput;
                    }
                    calculatorContainer.style.display = 'none';
                    return;
                }

                if (target.classList.contains('operator')) {
                    if (firstOperand === null) {
                        firstOperand = parseFloat(currentInput);
                    } else if (operator) {
                        firstOperand = calculate(operator, firstOperand, parseFloat(currentInput));
                    }
                    operator = value;
                    waitingForSecondOperand = true;
                    calcOutput.value = value;
                    return;
                }

                if (target.classList.contains('number')) {
                    if (waitingForSecondOperand) {
                        currentInput = value;
                        waitingForSecondOperand = false;
                    } else {
                        currentInput = currentInput === '0' ? value : currentInput + value;
                    }
                    calcOutput.value = currentInput;
                    return;
                }

                if (target.classList.contains('decimal')) {
                    if (!currentInput.includes('.')) {
                        currentInput += '.';
                        calcOutput.value = currentInput;
                    }
                    return;
                }
            }

            // --- Event Listeners ---
            navItems.forEach(item => item.addEventListener('click', (e) => switchView(e.currentTarget.dataset.view)));
            backToDashboardBtns.forEach(btn => btn.addEventListener('click', () => switchView('dashboard-view')));
            quickActionBtns.forEach(btn => btn.addEventListener('click', (e) => switchView(e.currentTarget.dataset.view)));
            document.querySelector('#add-borrow-lent-view .back-to-borrow-lent-btn').addEventListener('click', () => switchView('borrowed-lent-view'));
            
            themeToggleBtn.addEventListener('click', () => {
                const newTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
                applyTheme(newTheme);
            });
            calculatorToggleBtn.addEventListener('click', () => {
                const isVisible = calculatorContainer.style.display !== 'none';
                calculatorContainer.style.display = isVisible ? 'none' : 'grid';
                if (!isVisible) {
                    resetCalculator();
                }
            });
            calcButtons.addEventListener('click', handleCalculatorInput);

            transactionForm.addEventListener('submit', addOrUpdateTransaction);
            categoryListUl.addEventListener('click', (e) => {
                if (e.target.closest('.delete-category-btn')) {
                    deleteCategory(e.target.closest('.delete-category-btn').dataset.category);
                }
            });
            addNewCategoryBtn.addEventListener('click', addCategory);

            applyFilterBtn.addEventListener('click', applyFilters);
            clearFilterBtn.addEventListener('click', clearFilters);
            
            borrowLentForm.addEventListener('submit', addOrUpdateBorrowLent);
            addBorrowLentBtn.addEventListener('click', () => switchView('add-borrow-lent-view'));

            prevMonthBtn.addEventListener('click', () => {
                currentBudgetMonth.setMonth(currentBudgetMonth.getMonth() - 1);
                updateBudgetDisplay();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentBudgetMonth.setMonth(currentBudgetMonth.getMonth() + 1);
                updateBudgetDisplay();
            });
            saveBudgetGoalBtn.addEventListener('click', () => {
                const monthYear = `${currentBudgetMonth.getFullYear()}-${currentBudgetMonth.getMonth()}`;
                const newGoal = parseFloat(monthlyBudgetGoalInput.value);
                if (!isNaN(newGoal) && newGoal >= 0) {
                    monthlyBudgets[monthYear] = newGoal;
                    saveData();
                    updateBudgetDisplay();
                    alert('Monthly budget goal saved!');
                } else {
                    alert('Please enter a valid number for the budget goal.');
                }
            });

            backupDataBtn.addEventListener('click', backupData);
            restoreDataBtn.addEventListener('click', restoreData);
            forceMonthlySummaryBtn.addEventListener('click', () => {
            // Get the current date
            const now = new Date();
            // Simulate a month change by setting the last checked date to the previous month
            const previousMonth = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
            localStorage.setItem('lastCheckDate', previousMonth.toISOString());

            // Run the check and save function
            checkAndSaveMonthlySummary();
            
            // Refresh the page to see the changes
            location.reload(); 
        });
            
            // --- Initialization ---
            initializeApp();
        });
    </script>
</body>
</html>
